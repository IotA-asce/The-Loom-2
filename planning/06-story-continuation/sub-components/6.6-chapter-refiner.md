# Sub-Component 6.6: Chapter Refiner

## Purpose
Enable iterative improvement of generated chapters through user editing, AI-assisted rewriting, and refinement based on feedback.

---

## Requirements Gathering

### Question 1: Refinement Scope

**Should refinement be paragraph-level, scene-level, or chapter-level?**

Options:
- **A. Paragraph-level:** Fine-grained control
- **B. Scene-level:** Mid-level granularity
- **C. Chapter-level:** Broad changes only
- **D. Multi-level:** User can choose scope
- **E. Selection-based:** Any selected text

Considerations:
- Fine-grained = more control but more work
- Broad = faster but less precise
- Selection-based most flexible

### Question 2: Refinement Iterations

**How many refinement iterations should be supported?**

Options:
- **A. Unlimited:** No limit on iterations
- **B. Capped:** Max 5 iterations
- **C. Version-based:** Keep last 10 versions
- **D. Quality-based:** Until quality threshold
- **E. User-decided:** User stops when satisfied

Considerations:
- Unlimited = more flexibility
- But storage and complexity increase
- User satisfaction best metric

### Question 3: Learning from Edits

**Should user edits be used to fine-tune future generations?**

Options:
- **A. Yes, always:** Learn from every edit
- **B. Yes, explicit:** User approves learning
- **C. Pattern-based:** Learn repeated patterns
- **D. No, isolated:** Each chapter independent
- **E. Session-based:** Learn within session only

Considerations:
- Learning improves over time
- But may overfit to user quirks
- Privacy considerations

### Question 4: AI Assistance Features

**What AI assistance features are most helpful?**

Rank by importance:
- Rewrite selection (improve selected text)
- Expand description (add sensory details)
- Condense text (make more concise)
- Fix tone (adjust emotional tone)
- Add dialogue (insert conversation)
- Check continuity (validate consistency)
- Suggest improvements (general suggestions)

### Question 5: Version Management

**How should version history be managed?**

Options:
- **A. Linear history:** Simple version chain
- **B. Branching history:** Support experimentation
- **C. Diff view:** Show changes between versions
- **D. Named versions:** User names important versions
- **E. Auto-snapshots:** Save every few minutes

Considerations:
- Users may want to try different approaches
- Comparing versions helpful
- But too many options overwhelming

### Question 6: Collaboration Mode

**Should multiple refinement modes be supported?**

Options:
- **A. Solo only:** User edits alone
- **B. AI-assisted:** AI helps with edits
- **C. Co-writing:** User and AI write together
- **D. AI-first:** AI generates, user polishes
- **E. User-first:** User writes, AI improves

Considerations:
- Different users prefer different workflows
- Some want control, some want help
- Multiple modes support different styles

---

## Technical Considerations

### Refinement System

```typescript
interface ChapterRefiner {
  // Scopes
  refineParagraph: (paragraph: string, instruction: string) => string;
  refineScene: (scene: Scene, instruction: string) => Scene;
  refineChapter: (chapter: Chapter, instruction: string) => Chapter;
  
  // AI assistance
  suggestImprovements: (chapter: Chapter) => Suggestion[];
  rewriteSelection: (text: string, goal: string) => string;
  
  // Versioning
  saveVersion: (chapter: Chapter, note?: string) => Version;
  restoreVersion: (versionId: string) => Chapter;
  compareVersions: (v1: string, v2: string) => Diff;
}

interface RefinementSession {
  chapterId: string;
  iterations: RefinementIteration[];
  currentVersion: Chapter;
  learningData?: UserPreferenceData;
}
```

---

## Decisions Recorded

| Question | Decision | Rationale |
|----------|----------|-----------|
| 1. Refinement Scope | **D. Multi-level** | User can choose paragraph, scene, or chapter scope |
| 2. Refinement Iterations | **A. Unlimited** | No limit on refinement iterations |
| 3. Learning from Edits | **B. Yes, explicit** | User approves learning from edits |
| 4. AI Assistance Features | **All** | All features are important |
| 5. Version Management | **B. Branching history** | Support experimentation with branching versions |
| 6. Collaboration Mode | **B. AI-assisted** | AI helps with edits |

### Multi-Level Refinement Scope

```typescript
interface MultiLevelRefinement {
  // User chooses scope
  scope: 'user-choice';
  
  options: {
    selection: {
      label: 'Selected Text';
      granularity: 'any-selected-text';
    };
    paragraph: {
      label: 'Paragraph';
      granularity: 'single-paragraph';
    };
    scene: {
      label: 'Scene';
      granularity: 'full-scene';
    };
    chapter: {
      label: 'Chapter';
      granularity: 'entire-chapter';
    };
  };
  
  // Selection mode is default
  default: 'selection';
}
```

### Unlimited Refinement Iterations

```typescript
interface UnlimitedRefinementIterations {
  // No artificial limit
  maxIterations: 'unlimited';
  
  // Practical safeguards
  safeguards: {
    warnAt: 20;  // "You've done 20 iterations. Still going?"
    suggestFinalizing: 'after-quality-plateau';
  };
  
  // All versions preserved
  versionRetention: 'all';
  
  // Storage optimization
  storage: 'efficient-diffs';  // Store diffs, not full copies
}
```

### Explicit Learning from Edits

```typescript
interface ExplicitLearningFromEdits {
  // Not automatic
  automaticLearning: false;
  
  // User approval required
  approvalFlow: {
    afterEdits: 'Ask: "Use these edits to improve future chapters?"';
    options: {
      yes: 'Learn from this edit';
      no: 'One-time change only';
      pattern: 'Learn only if pattern detected';
    };
  };
  
  // What is learned
  learnablePatterns: {
    vocabulary: 'word choices';
    phrasing: 'sentence structures';
    pacing: 'scene lengths';
    description: 'detail levels';
    dialogue: 'dialogue density';
  };
}
```

### All AI Assistance Features

```typescript
interface AllAIAssistanceFeatures {
  // All features available
  features: {
    rewriteSelection: {
      enabled: true;
      description: 'Improve selected text';
    };
    expandDescription: {
      enabled: true;
      description: 'Add sensory details';
    };
    condenseText: {
      enabled: true;
      description: 'Make more concise';
    };
    fixTone: {
      enabled: true;
      description: 'Adjust emotional tone';
    };
    addDialogue: {
      enabled: true;
      description: 'Insert conversation';
    };
    checkContinuity: {
      enabled: true;
      description: 'Validate consistency';
    };
    suggestImprovements: {
      enabled: true;
      description: 'General suggestions';
    };
  };
  
  // All available in toolbar
  toolbar: 'all-features';
}
```

### Branching Version History

```typescript
interface BranchingVersionHistory {
  // Support experimentation
  structure: 'tree';  // Not linear
  
  // Can branch at any point
  operations: {
    commit: 'Save current state';
    branch: 'Create new branch from here';
    merge: 'Merge branches';
    switch: 'Switch to different branch';
    compare: 'Compare any two branches';
  };
  
  // Visual representation
  visualization: 'tree-diagram';
  
  // Example:
  // v1.0 → v2.0 → v3.0 (main branch)
  //    ↘
  //      v2.1 → v2.2 (experimental branch)
}
```

### AI-Assisted Collaboration

```typescript
interface AIAssistedCollaboration {
  mode: 'ai-assisted';
  
  workflow: {
    user: 'Primary author';
    ai: 'Assistant';
    
    interactions: {
      edit: 'User edits, AI offers improvements';
      suggest: 'AI suggests, user approves/rejects';
      generate: 'User requests, AI generates options';
      review: 'AI reviews, flags issues';
    };
  };
  
  // AI doesn't write without user
  autonomy: 'none';
  
  // AI helps when asked
  availability: 'on-demand';
}
```

---

## Status: ✅ Interrogation Complete

**Next: Sub-Component 6.7 — Story Archivist**
