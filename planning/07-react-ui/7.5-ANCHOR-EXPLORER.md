# 7.5 Anchor Explorer

## Overview
The Anchor Explorer allows users to browse, evaluate, and select anchor events â€” pivotal story moments where narrative branches can emerge. It presents detected anchors within the context of the storyline timeline, enabling users to understand each anchor's impact and choose the most compelling branching opportunities.

**User Value:** Visual identification of branching opportunities, impact assessment, confidence evaluation, direct branch generation workflow.

**Key Interactions:** Timeline browsing with anchor overlay, filtering by impact/confidence, anchor detail exploration, multi-select for batch operations, immediate branch generation.

---

## A. Core Functionality Questions

### A1. How should anchors be presented visually?
- [ ] Option A: List view with sortable columns
- [ ] Option B: Cards in a grid layout
- [ ] Option C: Overlay on timeline visualization
- [ ] Option D: Map/spatial representation
- [ ] Option E: Split view: timeline top, anchor list bottom

**Decision:** **E. Split view** â€” Contextual timeline awareness with detailed anchor list. 60% timeline, 40% anchor panel.

### A2. What filtering and sorting options are needed?
- [ ] Option A: None (chronological only)
- [ ] Option B: Confidence score only
- [ ] Option C: Confidence, impact level, chapter range, character involvement
- [ ] Option D: Full search with text queries
- [ ] Option E: AI-powered "suggested" anchors

**Decision:** **C + E** â€” Comprehensive filters plus AI suggestions for best branching candidates.

### A3. How should anchor selection work?
- [ ] Option A: Single select only
- [ ] Option B: Multi-select for batch comparison
- [ ] Option C: Range select (start to end anchor)
- [ ] Option D: Quick-action buttons on each anchor
- [ ] Option E: Drag to select multiple

**Decision:** **A + B + D** â€” Single select for immediate action, multi-select for comparison, quick actions always visible.

### A4. What anchor details should be displayed?
- [ ] Option A: Chapter/page location only
- [ ] Option B: Location + context snippet + confidence
- [ ] Option C: Full details including alternatives and impact
- [ ] Option D: Side-by-side with original manga page
- [ ] Option E: All details in expandable drawer

**Decision:** **C + D** â€” Rich details panel with optional manga page preview for context.

### A5. How should impact be visualized?
- [ ] Option A: Numeric score (0-100)
- [ ] Option B: Star rating (1-5)
- [ ] Option C: Color coding (low/medium/high impact)
- [ ] Option D: Ripple/branch visualization on timeline
- [ ] Option E: Story divergence preview

**Decision:** **C + D + E** â€” Color coding for quick scan, ripple effect on timeline, divergence preview on hover.

### A6. What happens after anchor selection?
- [ ] Option A: Immediate redirect to branch generation
- [ ] Option B: Stay in explorer, enable "Generate" button
- [ ] Option C: Show comparison of possible branch directions
- [ ] Option D: Modal with generation options
- [ ] Option E: Queue for batch generation

**Decision:** **B + D** â€” Selection enables generate button, click opens modal with options before proceeding.

---

## B. UI/UX Specifications

### B1. Layout & Structure

**Primary Layout:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Back]  Anchor Explorer: [Manga Title]              [?] [âš™ï¸]     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Filters: [All Impact â–¼] [Confidence >80% â–¼] [Chapter 1-10 â–¼] [ðŸ”]â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                               â”‚                                  â”‚
â”‚      TIMELINE VIEW            â”‚      ANCHOR DETAILS              â”‚
â”‚      (60% width)              â”‚      (40% width)                 â”‚
â”‚                               â”‚                                  â”‚
â”‚  â”€â”€â”€â—â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â—â”€â”€â”€   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚      â†‘      â†‘       â†‘    â†‘    â”‚  â”‚ [Anchor Title]           â”‚   â”‚
â”‚   [A1]   [A2]    [A3] [A4]    â”‚  â”‚ Chapter 5, Page 23       â”‚   â”‚
â”‚                               â”‚  â”‚                          â”‚   â”‚
â”‚  [Zoom: -] [====â—====] [+]    â”‚  â”‚ [Impact visualization]   â”‚   â”‚
â”‚                               â”‚  â”‚                          â”‚   â”‚
â”‚  [Story Context Preview]      â”‚  â”‚ Confidence: 94%          â”‚   â”‚
â”‚                               â”‚  â”‚ Impact: High             â”‚   â”‚
â”‚                               â”‚  â”‚                          â”‚   â”‚
â”‚                               â”‚  â”‚ "The protagonist makes   â”‚   â”‚
â”‚                               â”‚  â”‚  a critical decision..." â”‚   â”‚
â”‚                               â”‚  â”‚                          â”‚   â”‚
â”‚                               â”‚  â”‚ [View in Manga]          â”‚   â”‚
â”‚                               â”‚  â”‚                          â”‚   â”‚
â”‚                               â”‚  â”‚ [Generate Branches â†’]    â”‚   â”‚
â”‚                               â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                               â”‚                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [2 Selected]  [Compare Selected]  [Generate All â†’]              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Responsive Breakpoints:**
- Desktop (>1024px): Split view as shown
- Tablet (768-1024px): Timeline collapses to horizontal strip
- Mobile (<768px): Timeline top (25%), anchor list bottom (75%)

### B2. Visual Design

**Timeline Visualization:**
- Horizontal line representing story progression
- Chapter markers as vertical ticks
- Anchor points as pulsing circular indicators
- Color coding: Green (high confidence), Yellow (medium), Orange (low)
- Size indicates impact level (small/medium/large)
- Selected anchor: Ring highlight with shadow
- Hover: Tooltip with anchor title and quick stats

**Anchor Cards (in list):**
- Compact horizontal card layout
- Left: Impact indicator (colored bar)
- Center: Title, chapter/page, confidence badge
- Right: Quick action buttons (select, view, generate)
- Selected state: Blue left border, subtle background tint

**Impact Visualization:**
- Concentric ripple animation from anchor point
- Ripple size = impact radius on story
- Multiple ripples for cascading effects
- Toggle to show/hide ripple overlay

**Divergence Preview (on hover):**
- Mini tree diagram showing possible directions
- Branch thickness = likelihood
- Tooltip with 2-3 sentence description

**Apple Aesthetic:**
- Clean timeline with minimal chrome
- Subtle shadows on floating elements
- Smooth transitions between selections
- Purposeful use of accent colors

### B3. Animations & Interactions

**Timeline Interactions:**
- Pan: Click and drag, momentum continues
- Zoom: Pinch or +/- buttons, smooth scale 300ms
- Anchor hover: Pulsing ring animation, 400ms ease-in-out
- Selection: Ripple from click point, card slides into view

**Panel Transitions:**
- Anchor selection: Details panel slides in from right, 300ms
- Filter changes: List fades and reorders, stagger 50ms
- Multi-select: Counter animates, bottom bar slides up

**Scroll Behaviors:**
- Timeline: Horizontal scroll with snap to chapters
- Anchor list: Virtual scroll with smooth momentum
- Sync: Selecting anchor auto-scrolls timeline to position

**Micro-interactions:**
- Confidence badge: Subtle shimmer on high confidence
- Impact indicator: Bar grows on scroll into view
- Generate button: Scale up on ready state

**Keyboard Shortcuts:**
| Key | Action |
|-----|--------|
| `â†‘/â†“` | Navigate anchor list |
| `â†/â†’` | Scroll timeline |
| `Space` | Select/deselect anchor |
| `Enter` | Open generate modal |
| `F` | Toggle filters |
| `Esc` | Clear selection / back |

---

## C. Data & State Management

### C1. Data Requirements

**Input Data (from Anchor Detection):**
```typescript
interface AnchorEvent {
  id: string;
  mangaId: string;
  location: {
    chapter: number;
    page: number;
    panel?: number;
  };
  title: string;
  description: string;
  context: {
    before: string; // What happens before
    at: string;     // The anchor moment
    after: string;  // Original continuation
  };
  confidence: number; // 0-100
  impact: {
    level: 'low' | 'medium' | 'high' | 'critical';
    radius: number; // How many chapters affected
    description: string;
  };
  alternatives: string[]; // Possible alternative directions
  characterInvolvement: string[]; // Character IDs
  detectedAt: Date;
  aiAnalysis: {
    branchingPotential: number;
    narrativeWeight: number;
    thematicRelevance: number;
  };
}

interface AnchorFilterState {
  impactLevels: ('low' | 'medium' | 'high' | 'critical')[];
  minConfidence: number;
  chapterRange: { start: number; end: number };
  characters: string[];
  searchQuery: string;
  sortBy: 'confidence' | 'impact' | 'chapter' | 'suggested';
}
```

### C2. State Management

**Zustand Store:**
```typescript
interface AnchorExplorerStore {
  // Data
  anchors: AnchorEvent[];
  mangaId: string | null;
  
  // Selection state
  selectedAnchorId: string | null;
  selectedAnchorIds: string[]; // Multi-select
  
  // View state
  timelineZoom: number;
  timelineScrollX: number;
  filters: AnchorFilterState;
  
  // UI state
  hoveredAnchorId: string | null;
  showRippleOverlay: boolean;
  isGenerating: boolean;
  
  // Actions
  selectAnchor: (id: string | null) => void;
  toggleMultiSelect: (id: string) => void;
  selectRange: (startId: string, endId: string) => void;
  setFilter: (key: keyof AnchorFilterState, value: any) => void;
  setTimelineZoom: (zoom: number) => void;
  scrollTimelineTo: (chapter: number) => void;
  generateBranches: (anchorIds: string[]) => Promise<void>;
}
```

**Computed/Derived State:**
```typescript
interface DerivedState {
  filteredAnchors: AnchorEvent[];
  selectedAnchors: AnchorEvent[];
  hasSelection: boolean;
  multiSelectCount: number;
  timelineBounds: { minChapter: number; maxChapter: number };
}
```

---

## D. Performance & Optimization

### D1. Rendering Strategy

**Timeline Canvas:**
- Use HTML5 Canvas for timeline rendering (thousands of potential points)
- GPU-accelerated transforms for zoom/pan
- RequestAnimationFrame for smooth animation

**Virtualization:**
- Anchor list: react-window with dynamic row heights
- Timeline events: Render only visible range Â± buffer

**Debounced Updates:**
- Filter changes: 150ms debounce
- Search input: 300ms debounce
- Timeline scroll: Throttle to 60fps

### D2. Data Optimization

**Pre-computed Indices:**
- Anchors indexed by chapter for quick lookup
- Spatial index for timeline hit detection
- Sorted arrays for filter operations

**Caching:**
- Anchor data cached per manga
- Filter results memoized
- Thumbnail previews cached

### D3. Performance Targets

| Metric | Target |
|--------|--------|
| Initial Load | < 800ms |
| Filter Application | < 200ms |
| Timeline Zoom/Pan | 60fps |
| Anchor Selection | < 100ms |
| List Scroll | 60fps |
| Generate Modal Open | < 150ms |

---

## E. Error Handling & Edge Cases

### E1. No Anchors Detected
- State: "No anchor events found"
- Message: "Try adjusting filters or re-analyzing with different settings"
- Actions: "Adjust Filters" | "Re-Analyze" | "Manual Anchor Creation"

### E2. All Anchors Filtered Out
- State: "No anchors match current filters"
- Show: "Clear all filters" button
- Suggest: "Try lowering confidence threshold"

### E3. Timeline Too Long (>200 chapters)
- Solution: Chapter grouping (volumes/arcs)
- Zoom default: Fit to screen with chapter clusters
- Expand clusters on zoom in

### E4. Low Confidence Anchors Only
- Warning banner: "Most anchors have low confidence - results may vary"
- Suggest re-analysis or manual review
- Default filter to show medium+ confidence

### E5. Generate Failure
- Modal error with specific anchor issue
- Partial success: Show which anchors succeeded/failed
- Retry with modified parameters

### E6. Browser Performance Issues
- Detect frame rate drops
- Auto-suggest: "Simplify view for better performance?"
- Option to disable ripple effects, reduce animation

---

## Feature Summary

| ID | Feature | Priority | Est. Hours |
|----|---------|----------|------------|
| F1 | Split-view timeline + anchor panel | P0 | 10 |
| F2 | Interactive timeline with zoom/pan | P0 | 12 |
| F3 | Anchor filtering and sorting | P0 | 8 |
| F4 | Anchor detail panel | P0 | 8 |
| F5 | Multi-select with batch actions | P1 | 6 |
| F6 | Impact visualization (ripples) | P1 | 8 |
| F7 | Divergence preview on hover | P1 | 6 |
| F8 | Manga page context preview | P1 | 6 |
| F9 | Generate branch modal | P1 | 6 |
| F10 | AI-suggested anchors | P2 | 6 |
| F11 | Canvas-based timeline rendering | P2 | 8 |
| F12 | Keyboard navigation | P2 | 4 |
| F13 | Accessibility support | P1 | 8 |

## Effort Estimate

**Total Estimated Hours: 100 hours**

**Breakdown:**
- Core timeline implementation: 30 hours
- Anchor management UI: 24 hours
- Visualizations and effects: 20 hours
- Data integration: 16 hours
- Performance optimization: 6 hours
- Testing and refinement: 4 hours
