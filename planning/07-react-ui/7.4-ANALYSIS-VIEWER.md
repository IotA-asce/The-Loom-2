# 7.4 Analysis Viewer

## Overview
The Analysis Viewer presents AI-generated storyline analysis results in an intuitive, navigable interface. Users can explore character profiles, timeline visualizations, and thematic breakdowns of their manga. This component transforms raw analysis data into an insightful narrative exploration tool, enabling users to understand story structure before creating branches.

**User Value:** Deep story comprehension, character relationship mapping, timeline visualization for identifying branch opportunities.

**Key Interactions:** Timeline navigation, character card exploration, view mode switching, filtering by story elements, export for sharing.

---

## A. Core Functionality Questions

### A1. What are the primary view modes for analysis presentation?
- [ ] Option A: Single unified view with all information
- [ ] Option B: Tabbed interface (Timeline, Characters, Themes, Summary)
- [ ] Option C: Split-pane with timeline and detail panels
- [ ] Option D: Graph/network visualization as primary
- [ ] Option E: Manga-style side-by-side with annotations

**Decision:** **B. Tabbed interface** — Clean separation of concerns, allows focused exploration of each dimension. Default to Timeline tab.

### A2. How should the timeline visualization be rendered?
- [ ] Option A: Horizontal scrollable timeline with events
- [ ] Option B: Vertical chapter-based list
- [ ] Option C: Branching tree showing story structure
- [ ] Option D: Comic strip style with page thumbnails
- [ ] Option E: Synchronized with manga reader (split view)

**Decision:** **A. Horizontal scrollable timeline** — Familiar pattern, fits desktop-first approach, allows chronological exploration with zoom capabilities.

### A3. What character information should be displayed?
- [ ] Option A: Name and appearance only
- [ ] Option B: Full profile (name, role, traits, relationships, arc summary)
- [ ] Option C: Relationship graph visualization
- [ ] Option D: Character timeline showing appearances
- [ ] Option E: All of the above in expandable cards

**Decision:** **E. All of the above in expandable cards** — Start compact, allow deep exploration. Card format maintains Apple aesthetic.

### A4. How should users interact with analysis data?
- [ ] Option A: Read-only presentation
- [ ] Option B: Light editing (notes, tags, ratings)
- [ ] Option C: Full editing (correct character info, adjust timeline)
- [ ] Option D: Feedback system (mark inaccuracies for re-analysis)
- [ ] Option E: Branch creation directly from analysis elements

**Decision:** **B + D + E** — Light editing for user notes, feedback for inaccuracies, and direct branch creation from timeline/characters.

### A5. What export options should be available?
- [ ] Option A: No export (view only)
- [ ] Option B: PDF export of analysis
- [ ] Option C: JSON export for data portability
- [ ] Option D: Shareable link (if cloud sync enabled)
- [ ] Option E: Print-friendly view

**Decision:** **B + C + E** — PDF for sharing/reading, JSON for power users, print-friendly for documentation.

### A6. How should analysis in-progress be handled?
- [ ] Option A: Block access until complete
- [ ] Option B: Show partial results as they arrive
- [ ] Option C: Separate progress view (see 7.3)
- [ ] Option D: Background refresh with notification
- [ ] Option E: Streaming real-time updates to viewer

**Decision:** **B + E** — Show partial results immediately, stream updates in real-time for engaging experience.

---

## B. UI/UX Specifications

### B1. Layout & Structure
- [ ] Option A: Full-screen dedicated view
- [ ] Option B: Modal overlay on library
- [ ] Option C: Sidebar panel in main window
- [ ] Option D: Integrated with manga reader

**Decision:** **A. Full-screen dedicated view** — Analysis deserves full attention, complex data needs space.

**Layout Structure:**
```
┌─────────────────────────────────────────────────────────────┐
│  [Back]  Analysis Results: [Manga Title]          [Export ▼] │
├─────────────────────────────────────────────────────────────┤
│  [Summary] [Timeline] [Characters] [Themes] [Relationships] │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│                      [TAB CONTENT]                          │
│                                                             │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  [Find Anchors →]                                [Re-Analyze]│
└─────────────────────────────────────────────────────────────┘
```

**Specifications:**
- Top navigation: 64px height, back button left, actions right
- Tab bar: 48px height, horizontal scroll on mobile
- Content area: Full remaining height with internal scroll
- Bottom action bar: 72px height, contextual primary action

### B2. Visual Design

**Timeline Tab:**
- Horizontal timeline with zoom (0.5x to 3x)
- Event markers as dots with chapter labels
- Event cards on hover/click
- Color-coded by event type (plot, character, theme)
- Current position indicator line

**Characters Tab:**
- Masonry grid of character cards
- Card: Avatar (generated or placeholder), name, role badge
- Expandable to show full profile
- Filter chips by role (Protagonist, Antagonist, Supporting)

**Themes Tab:**
- Tag cloud with size indicating prominence
- Theme cards with description and occurrence count
- Related themes connections

**Relationships Tab:**
- Force-directed graph visualization
- Zoom and pan controls
- Relationship type indicators (line styles)

**Apple Aesthetic Application:**
- Generous whitespace between sections (32px)
- Cards with subtle shadow (0 2px 8px rgba(0,0,0,0.08))
- Rounded corners (12px for cards, 8px for buttons)
- SF Pro typography hierarchy
- Accent color (#0071e3) for interactive elements

### B3. Animations & Interactions

**Page Transitions:**
- Fade in from library: 300ms ease-out
- Content sections stagger: 50ms delay between elements

**Tab Switching:**
- Slide content horizontally: 250ms ease-in-out
- Fade out current, fade in new
- Underline indicator slides to active tab: 200ms spring

**Card Interactions:**
- Hover: Scale 1.02, shadow increase, 200ms ease-out
- Expand: Height animation 300ms, content fades in
- Character avatar: Subtle float animation on hover

**Timeline Interactions:**
- Scroll momentum with inertia
- Zoom: Smooth scale transition 300ms
- Event selection: Ripple effect, card slides up from bottom

**Keyboard Shortcuts:**
| Key | Action |
|-----|--------|
| `←/→` | Navigate timeline |
| `1-5` | Switch tabs |
| `E` | Export |
| `F` | Find anchors |
| `Esc` | Back to library |

---

## C. Data & State Management

### C1. Data Requirements

**Input Data (from Analysis):**
```typescript
interface AnalysisData {
  mangaId: string;
  status: 'complete' | 'partial' | 'streaming';
  summary: {
    title: string;
    synopsis: string;
    chapterCount: number;
    pageCount: number;
  };
  timeline: TimelineEvent[];
  characters: CharacterProfile[];
  themes: ThemeAnalysis[];
  relationships: RelationshipMap;
  metadata: {
    analyzedAt: Date;
    version: string;
    confidence: number;
  };
}

interface TimelineEvent {
  id: string;
  chapter: number;
  page: number;
  type: 'plot' | 'character' | 'theme' | 'setting';
  title: string;
  description: string;
  charactersInvolved: string[];
  importance: 'minor' | 'major' | 'critical';
}

interface CharacterProfile {
  id: string;
  name: string;
  aliases: string[];
  role: 'protagonist' | 'antagonist' | 'supporting' | 'minor';
  traits: string[];
  description: string;
  firstAppearance: { chapter: number; page: number };
  arcSummary: string;
  relationships: CharacterRelationship[];
}
```

**User-Generated Data:**
```typescript
interface UserAnalysisNotes {
  mangaId: string;
  notes: {
    entityId: string; // character, event, or theme id
    entityType: 'character' | 'event' | 'theme';
    note: string;
    createdAt: Date;
  }[];
  ratings: {
    entityId: string;
    accuracy: 1-5; // User rating of AI analysis
  }[];
  tags: string[];
}
```

### C2. State Management

**Zustand Store:**
```typescript
interface AnalysisViewerStore {
  // Current view state
  currentMangaId: string | null;
  activeTab: 'summary' | 'timeline' | 'characters' | 'themes' | 'relationships';
  
  // Timeline state
  timelineZoom: number;
  timelineScrollPosition: number;
  selectedEventId: string | null;
  
  // Character view state
  selectedCharacterId: string | null;
  characterFilter: 'all' | 'protagonist' | 'antagonist' | 'supporting';
  expandedCharacterIds: string[];
  
  // UI state
  isExporting: boolean;
  showAccuracyFeedback: boolean;
  
  // Actions
  setActiveTab: (tab: string) => void;
  selectEvent: (id: string | null) => void;
  selectCharacter: (id: string | null) => void;
  toggleCharacterExpand: (id: string) => void;
  setTimelineZoom: (zoom: number) => void;
  addNote: (entityId: string, note: string) => void;
  exportAnalysis: (format: 'pdf' | 'json') => Promise<void>;
}
```

**Data Flow:**
1. Component mounts → Fetch analysis data from Dexie.js
2. Subscribe to real-time updates if analysis still streaming
3. User interactions update local state immediately
4. Notes/ratings persisted to IndexedDB via Zustand

---

## D. Performance & Optimization

### D1. Rendering Strategy

**Virtualization:**
- Timeline: Virtualize events outside viewport (react-window)
- Character grid: Virtualize if > 50 characters
- Relationship graph: Canvas-based for performance

**Lazy Loading:**
- Character avatars loaded on scroll
- Relationship graph deferred until tab active
- Theme details expand on demand

### D2. Data Optimization

**Caching:**
- Analysis data cached in Zustand with stale-while-revalidate
- Character profiles memoized
- Timeline events sorted and indexed by chapter

**Streaming Updates:**
- WebSocket or Server-Sent Events for real-time analysis
- Incremental UI updates with React.memo
- Batch state updates every 100ms during streaming

### D3. Bundle Optimization

**Code Splitting:**
- Relationship graph as separate chunk (heavy D3/Canvas)
- PDF export functionality lazy loaded
- Theme tab components code-split

### D4. Performance Targets

| Metric | Target |
|--------|--------|
| Initial Render | < 500ms |
| Tab Switch | < 200ms |
| Timeline Scroll | 60fps |
| Character Expand | < 150ms |
| Export Generation | < 3s |

---

## E. Error Handling & Edge Cases

### E1. Analysis Not Found
- Display: Illustration + "Analysis not available" message
- Actions: "Start Analysis" button, "Back to Library"
- Auto-redirect to progress view if analysis in progress

### E2. Incomplete Analysis
- Show partial data with "Analysis in progress" banner
- Streaming indicator (pulsing dot + "Updating...")
- Disabled features that require complete data

### E3. Large Dataset (>100 chapters)
- Timeline: Virtual scrolling with chapter jump navigation
- Characters: Pagination or infinite scroll
- Warning: "Large analysis - some features may be slower"

### E4. No Characters/Events Detected
- Empty state with specific messaging
- "This may indicate a detection issue"
- "Re-analyze with different settings" option

### E5. Export Failures
- Inline error with retry option
- Partial export with failed items listed
- Alternative format suggestions

### E6. Browser Storage Full
- Graceful degradation (view only, no notes)
- Warning banner with storage management link
- Export prompt to free space

---

## Feature Summary

| ID | Feature | Priority | Est. Hours |
|----|---------|----------|------------|
| F1 | Tabbed interface with 5 views | P0 | 8 |
| F2 | Horizontal scrollable timeline | P0 | 12 |
| F3 | Character card grid with expansion | P0 | 10 |
| F4 | Theme visualization | P1 | 6 |
| F5 | Relationship graph | P1 | 10 |
| F6 | Real-time streaming updates | P1 | 8 |
| F7 | User notes and ratings | P1 | 6 |
| F8 | Export (PDF, JSON, Print) | P1 | 8 |
| F9 | Timeline zoom and navigation | P2 | 6 |
| F10 | Keyboard shortcuts | P2 | 4 |
| F11 | Virtualized rendering for large data | P2 | 8 |
| F12 | Accessibility (screen reader, keyboard) | P1 | 10 |

## Effort Estimate

**Total Estimated Hours: 96 hours**

**Breakdown:**
- Core functionality: 40 hours
- UI/UX implementation: 30 hours
- Data integration: 16 hours
- Performance optimization: 6 hours
- Testing and refinement: 4 hours
