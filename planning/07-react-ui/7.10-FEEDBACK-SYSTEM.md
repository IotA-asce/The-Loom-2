# 7.10 Feedback System

## Overview
The Feedback System provides comprehensive error handling, user feedback collection, and system status monitoring. It includes error boundaries for graceful crash recovery, in-app feedback forms, debug information collection, and health monitoring for API connections and storage.

**User Value:** Graceful error recovery, easy bug reporting, visibility into system health, voice in product development.

**Key Interactions:** Error boundary recovery, feedback form submission, system status dashboard, debug log collection, automatic error reporting.

---

## A. Core Functionality Questions

### A1. How should errors be presented to users?
- [ ] Option A: Technical error messages
- [ ] Option B: Friendly error messages with technical details hidden
- [ ] Option C: Contextual recovery suggestions
- [ ] Option D: Visual illustrations by error type
- [ ] Option E: All of the above with progressive disclosure

**Decision:** **E** — Friendly primary message, recovery actions, expandable technical details, contextual illustrations.

### A2. What error recovery options should be available?
- [ ] Option A: Reload page only
- [ ] Option B: Retry action, reset component
- [ ] Option C: Safe mode (disable features)
- [ ] Option D: Automatic recovery attempts
- [ ] Option E: All options contextually

**Decision:** **E** — Contextual recovery: retry for network, reset for state, safe mode for persistent errors.

### A3. How should user feedback be collected?
- [ ] Option A: Email link only
- [ ] Option B: In-app form with categories
- [ ] Option C: Screenshot + annotation
- [ ] Option D: Automatic context collection
- [ ] Option E: Multiple channels (form, email, chat)

**Decision:** **B + D** — In-app categorized form with automatic context (logs, state, environment) attachment.

### A4. What system status should be visible?
- [ ] Option A: None (background only)
- [ ] Option B: Error states only
- [ ] Option C: Status dashboard (API, storage, queue)
- [ ] Option D: Real-time health indicators
- [ ] Option E: Detailed diagnostic panel

**Decision:** **C + D** — Collapsible status bar with real-time indicators, expandable dashboard for details.

### A5. How should debug information be handled?
- [ ] Option A: Console only
- [ ] Option B: Downloadable log file
- [ ] Option C: In-app log viewer
- [ ] Option D: Automatic submission with feedback
- [ ] Option E: All with user consent

**Decision:** **B + C + E** — In-app log viewer for developers, export option, automatic attachment with explicit consent.

### A6. What should trigger automatic error reports?
- [ ] Option A: Nothing (manual only)
- [ ] Option B: Crashes only
- [ ] Option C: Crashes + unhandled errors
- [ ] Option D: All errors with sampling
- [ ] Option E: User-configurable level

**Decision:** **B + C + E** — Crashes and unhandled errors auto-reported if user opts in, configurable in settings.

---

## B. UI/UX Specifications

### B1. Layout & Structure

**Error Boundary (Full Page):**
```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│                                                                     │
│                    [Illustration: Something Went Wrong]             │
│                                                                     │
│                    Oops! Something went wrong                       │
│                                                                     │
│          We're sorry, but The Loom encountered an error.            │
│          Your work has been saved.                                  │
│                                                                     │
│              [Try Again]  [Go to Library]  [Report Issue]           │
│                                                                     │
│          ───────────────────────────────────────────────            │
│          Technical Details (for support)                            │
│          [Error: Component X failed to render...]                   │
│          [Copy] [Download Logs]                                     │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**Error Boundary (Component-Level):**
```
┌─────────────────────────────────────────┐
│  ⚠️  Failed to load analysis           │
│                                      │
│  [Retry]    [Dismiss]    [Report]    │
└─────────────────────────────────────────┘
```

**Feedback Form:**
```
┌─────────────────────────────────────────────────────────────────────┐
│  Send Feedback                                          [× Close]   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Feedback Type                                                      │
│  [○ Bug Report  ○ Feature Request  ○ General Feedback  ○ Question] │
│                                                                     │
│  Title                                                              │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ Brief summary of your feedback                              │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  Description                                                        │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │ Please describe in detail...                                │   │
│  │                                                             │   │
│  │                                                             │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
│  [☑] Include system information and logs                           │
│  [☑] Allow contact for follow-up questions                         │
│                                                                     │
│              [Cancel]              [Send Feedback →]                │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**Status Bar (Collapsible):**
```
┌─────────────────────────────────────────────────────────────────────┐
│  ● All Systems Operational        [Details ▼]     [Submit Feedback] │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐   │
│  │  LLM API    │ │   Storage   │ │   Analysis  │ │   IndexedDB │   │
│  │   ● Online  │ │  ● 2.3GB    │ │   ○ Idle    │ │   ● Ready   │   │
│  │  45ms       │ │    free     │ │             │ │             │   │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
```

**Toast Notifications:**
```
Position: Bottom-right stack (max 3)

┌─────────────────────────────┐
│ ✅ Upload Complete          │
│    "MangaName" uploaded     │
│                    [×]      │
└─────────────────────────────┘

┌─────────────────────────────┐
│ ⚠️  Analysis Warning        │
│    Low confidence detected  │
│    [View]          [×]      │
└─────────────────────────────┘

┌─────────────────────────────┐
│ ❌ Generation Failed        │
│    API key invalid          │
│    [Fix]           [×]      │
└─────────────────────────────┘
```

### B2. Visual Design

**Error Illustrations:**
- Network error: Disconnected cable/plug illustration
- API error: Server with warning icon
- Storage error: Full hard drive illustration
- Unknown error: Confused robot/mascot
- Success: Checkmark with celebration

**Status Indicators:**
- Healthy: Green dot, pulsing slowly
- Warning: Yellow triangle, static
- Error: Red circle with X, attention pulse
- Loading: Blue spinner
- Offline: Gray dash

**Toast Styling:**
- Success: Green left border, checkmark icon
- Warning: Yellow left border, triangle icon
- Error: Red left border, X icon
- Info: Blue left border, info icon
- Auto-dismiss: 5 seconds (except errors)
- Swipe to dismiss on mobile

**Feedback Form:**
- Clean card layout on dark overlay
- Step indicator for multi-step flows
- Character count for text areas
- File attachment (screenshots)

**Apple Aesthetic:**
- Minimal chrome on toasts
- Subtle shadows for depth
- Rounded corners (12px)
- Generous padding
- Purposeful color coding

### B3. Animations & Interactions

**Error Boundary:**
- Illustration: Gentle floating animation
- Content: Fade in with stagger, 100ms
- Buttons: Subtle hover lift

**Toast Notifications:**
- Entrance: Slide from right + fade, 300ms ease-out
- Exit: Fade out + shrink, 200ms
- Stack: Existing toasts slide up
- Progress bar: Width animation for auto-dismiss

**Status Bar:**
- Expand: Height animation + content fade, 250ms
- Indicator pulse: 2s infinite ease-in-out
- Status change: Color transition, 300ms

**Feedback Form:**
- Open: Scale from 0.95 + fade, 250ms
- Close: Fade out, 200ms
- Submit: Button loading state, success checkmark
- Field focus: Border glow animation

**Error Recovery:**
- Retry: Button spinner, then refresh animation
- Reset: Fade out old, fade in new content
- Safe mode: Gradual feature disable with explanation

---

## C. Data & State Management

### C1. Data Requirements

**Error Data:**
```typescript
interface AppError {
  id: string;
  timestamp: Date;
  type: 'crash' | 'network' | 'api' | 'validation' | 'unknown';
  severity: 'critical' | 'error' | 'warning' | 'info';
  message: string;
  userMessage: string;
  component?: string;
  stackTrace?: string;
  context: {
    url: string;
    userAgent: string;
    appVersion: string;
    state?: Record<string, any>;
  };
  recoveryAttempted: boolean;
  recoverySuccessful?: boolean;
}

interface ErrorBoundaryState {
  hasError: boolean;
  error: AppError | null;
  errorInfo: React.ErrorInfo | null;
  componentStack: string;
}
```

**Feedback Data:**
```typescript
interface UserFeedback {
  id: string;
  submittedAt: Date;
  type: 'bug' | 'feature' | 'feedback' | 'question';
  title: string;
  description: string;
  userInfo: {
    email?: string;
    allowContact: boolean;
  };
  systemInfo: {
    appVersion: string;
    browser: string;
    os: string;
    screenSize: string;
  };
  logs: string;
  screenshot?: Blob;
  route: string;
  timestamp: Date;
}
```

**System Status:**
```typescript
interface SystemStatus {
  lastChecked: Date;
  overall: 'healthy' | 'degraded' | 'unhealthy';
  services: {
    llmApi: {
      status: 'online' | 'offline' | 'slow';
      latency?: number;
      lastError?: string;
    };
    storage: {
      status: 'healthy' | 'full' | 'error';
      usedBytes: number;
      totalBytes: number;
    };
    indexedDB: {
      status: 'connected' | 'error';
      version: number;
    };
    analysisQueue: {
      status: 'idle' | 'processing' | 'backlogged';
      pendingJobs: number;
    };
  };
}
```

**Debug Logs:**
```typescript
interface LogEntry {
  timestamp: Date;
  level: 'debug' | 'info' | 'warn' | 'error';
  category: string;
  message: string;
  data?: any;
  stackTrace?: string;
}

interface DebugLogStore {
  logs: LogEntry[];
  maxEntries: number;
  filters: {
    level: LogEntry['level'][];
    category: string[];
    search: string;
  };
}
```

### C2. State Management

**Zustand Store:**
```typescript
interface FeedbackSystemStore {
  // Errors
  errors: AppError[];
  unhandledError: AppError | null;
  
  // Notifications
  toasts: Toast[];
  
  // System status
  systemStatus: SystemStatus;
  isStatusExpanded: boolean;
  
  // Feedback form
  isFeedbackOpen: boolean;
  feedbackDraft: Partial<UserFeedback>;
  isSubmitting: boolean;
  
  // Debug
  debugLogs: LogEntry[];
  isDebugPanelOpen: boolean;
  
  // Actions
  reportError: (error: Error, context?: any) => void;
  recoverFromError: (strategy: 'retry' | 'reset' | 'safe') => void;
  clearError: () => void;
  
  // Notifications
  showToast: (toast: Omit<Toast, 'id'>) => void;
  dismissToast: (id: string) => void;
  dismissAllToasts: () => void;
  
  // System status
  checkSystemStatus: () => Promise<void>;
  toggleStatusPanel: () => void;
  
  // Feedback
  openFeedback: (type?: UserFeedback['type']) => void;
  closeFeedback: () => void;
  updateFeedbackDraft: (updates: Partial<UserFeedback>) => void;
  submitFeedback: () => Promise<void>;
  
  // Debug
  addLogEntry: (entry: Omit<LogEntry, 'timestamp'>) => void;
  clearLogs: () => void;
  exportLogs: () => string;
  toggleDebugPanel: () => void;
}
```

---

## D. Performance & Optimization

### D1. Error Handling Performance

**Error Boundaries:**
- Static fallback UI (no complex rendering)
- Lazy load detailed error components
- Immediate state capture on error

**Log Management:**
- Ring buffer for logs (max 1000 entries)
- Async write to IndexedDB
- Sample rate for high-frequency errors

### D2. Notification System

**Toast Limits:**
- Max 3 visible toasts
- Queue overflow behavior: Drop oldest
- Prioritize errors over info

**Animation Performance:**
- Use transform and opacity only
- GPU-accelerated animations
- Respect prefers-reduced-motion

### D3. Performance Targets

| Metric | Target |
|--------|--------|
| Error Boundary Render | < 100ms |
| Toast Display | < 50ms |
| Status Check | < 2s |
| Feedback Submit | < 3s |
| Log Export | < 1s |

---

## E. Error Handling & Edge Cases

### E1. Error Boundary Failure
- Ultimate fallback: Plain HTML page
- Message: "Critical error - please reload"
- Auto-refresh option with countdown

### E2. Feedback Submit Failure
- Queue for retry
- Local save of draft
- Email fallback option
- Notification on successful retry

### E3. Debug Log Storage Full
- Automatic rotation (FIFO)
- Warning at 80% capacity
- Export prompt at 95%

### E4. Status Check Failure
- Show last known status with timestamp
- "Status unavailable" warning
- Don't block UI for status checks

### E5. Rate-Limited Error Reporting
- Deduplicate similar errors
- Exponential backoff for retries
- User notification: "Error reports queued"

### E6. Privacy Concerns
- Explicit opt-in for automatic reporting
- Clear data inclusion list
- One-click opt-out
- Local-only mode option

---

## Feature Summary

| ID | Feature | Priority | Est. Hours |
|----|---------|----------|------------|
| F1 | Error boundary (full page) | P0 | 8 |
| F2 | Error boundary (component) | P0 | 6 |
| F3 | Recovery actions (retry/reset/safe) | P0 | 8 |
| F4 | Toast notification system | P0 | 8 |
| F5 | Feedback form with categories | P0 | 10 |
| F6 | Automatic context collection | P1 | 6 |
| F7 | System status dashboard | P1 | 8 |
| F8 | Real-time health indicators | P1 | 6 |
| F9 | Debug log viewer | P2 | 8 |
| F10 | Log export functionality | P2 | 4 |
| F11 | Error deduplication | P2 | 4 |
| F12 | Privacy controls | P1 | 6 |
| F13 | Accessibility (error announcements) | P1 | 6 |

## Effort Estimate

**Total Estimated Hours: 98 hours**

**Breakdown:**
- Error boundaries and recovery: 24 hours
- Notification system: 16 hours
- Feedback form: 18 hours
- System status monitoring: 16 hours
- Debug and logging: 14 hours
- Testing and edge cases: 10 hours
