# 7.7 Story Reader

## Overview
The Story Reader provides an immersive reading experience for generated story content, optimized for manga-style narratives. It supports right-to-left reading flow, panel-by-panel focus modes, and seamless branch switching to explore different story directions without leaving the reader.

**User Value:** Immersive reading experience, easy branch exploration, progress tracking, distraction-free mode, manga-appropriate layout.

**Key Interactions:** Chapter navigation, branch switching, reading preferences (font, theme), bookmarking, progress sync.

---

## A. Core Functionality Questions

### A1. What is the primary reading layout?
- [ ] Option A: Vertical scroll (web novel style)
- [ ] Option B: Paginated with page turns
- [ ] Option C: Manga-style right-to-left with spreads
- [ ] Option D: Panel-by-panel focus mode
- [ ] Option E: All modes with user toggle

**Decision:** **E. All modes with user toggle** â€” Default to vertical scroll, offer manga and panel modes for variety.

### A2. How should branch switching work within the reader?
- [ ] Option B: Inline notification with expand option
- [ ] Option C: Sidebar panel showing branch options
- [ ] Option D: Decision point modal at anchor locations
- [ ] Option E: Seamless switch with back button

**Decision:** **C + E** â€” Collapsible branch panel, one-click switch with history back navigation.

### A3. What reading progress should be tracked?
- [ ] Option A: Chapter-level only
- [ ] Option B: Scroll position within chapter
- [ ] Option C: Paragraph/section granularity
- [ ] Option D: Time spent reading
- [ ] Option E: All of the above with statistics

**Decision:** **B + D + E** â€” Precise scroll position, reading time, optional statistics dashboard.

### A4. How should the table of contents be presented?
- [ ] Option A: Dropdown menu
- [ ] Option B: Sidebar drawer
- [ ] Option C: Full-screen overlay
- [ ] Option D: Bottom progress bar with chapter marks
- [ ] Option E: Minimap of chapter structure

**Decision:** **B + D** â€” Drawer for detailed navigation, progress bar for quick orientation.

### A5. What customization options are needed?
- [ ] Option A: None (fixed design)
- [ ] Option B: Font size only
- [ ] Option C: Font, size, theme, line spacing
- [ ] Option D: Full typographic control
- [ ] Option E: Per-story preferences

**Decision:** **C + E** â€” Comprehensive typography controls with per-story memory.

### A6. How to handle editing while reading?
- [ ] Option A: No editing in reader
- [ ] Option B: Highlight text to edit
- [ ] Option C: Separate edit mode toggle
- [ ] Option D: Inline editing on double-click
- [ ] Option E: AI assistant panel for edits

**Decision:** **C + E** â€” Toggle edit mode, AI assistant panel for suggestions and refinements.

---

## B. UI/UX Specifications

### B1. Layout & Structure

**Primary Reading Layout:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [â† Back]  Story Title - Chapter 5              [ğŸ”–] [âš™ï¸] [â† â†’]    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       â”‚                                             â”‚
â”‚   TABLE OF CONTENTS   â”‚                                             â”‚
â”‚   (collapsible)       â”‚         READING CONTENT                     â”‚
â”‚                       â”‚                                             â”‚
â”‚   Ch 1                â”‚         Lorem ipsum dolor sit amet,         â”‚
â”‚   Ch 2                â”‚         consectetur adipiscing elit.        â”‚
â”‚   Ch 3                â”‚         Sed do eiusmod tempor               â”‚
â”‚ â†’ Ch 4                â”‚         incididunt ut labore...             â”‚
â”‚   Ch 5 â—              â”‚                                             â”‚
â”‚   Ch 6                â”‚         [Continue scrolling]                â”‚
â”‚   Ch 7                â”‚                                             â”‚
â”‚                       â”‚                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [Branch: Original â†’]  [Progress: 45%]  [Time: 12m]                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Branch Switching Panel:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Branch Point: Chapter 5            â”‚
â”‚  "The Critical Decision"            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â—‹ Original Story                   â”‚
â”‚  â— Branch A: "The Dark Path"   â†    â”‚
â”‚  â—‹ Branch B: "The Hero's Choice"    â”‚
â”‚  â—‹ Branch C: "Unexpected Alliance"  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [â† Back to Branch Studio]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Reading Modes:**

1. **Vertical Scroll (Default):**
   - Continuous scroll through chapter
   - Scroll progress indicator
   - Next chapter loads automatically
   - Apple-style clean typography

2. **Manga Mode (RTL):**
   - Right-to-left page flow
   - Spread view option
   - Tap edges to navigate
   - Page turn animation

3. **Focus Mode:**
   - One paragraph/panel at a time
   - Centered content
   - Progress dots at bottom
   - Dimmer background

### B2. Visual Design

**Typography:**
- Default: System font stack (SF Pro on Apple)
- Options: Serif, Sans-serif, Monospace (for code/dialogue)
- Sizes: Small (16px), Medium (18px), Large (20px), XL (22px)
- Line height: 1.6 (default), 1.8 (spacious)

**Themes:**
- Light: White background, #1d1d1f text
- Dark: #1d1d1f background, #f5f5f7 text
- Sepia: Warm cream background, brown text
- Auto: Match system preference

**Content Styling:**
- Chapter title: Title 1 (28px, bold)
- Scene breaks: Centered decorative divider
- Dialogue: Slight indent, quotation styling
- Emphasis: Italic, accent color for strong

**Progress Indicators:**
- Top: Thin progress bar (chapter completion)
- Bottom: Chapter navigation dots
- Sidebar: TOC with current indicator

**Branch Indicator:**
- Floating pill at bottom: "Branch: [Name]"
- Color-coded by branch type
- Click to expand branch panel

**Apple Aesthetic:**
- Maximum content space, minimal chrome
- Thin dividers, generous whitespace
- Subtle shadows for floating elements
- Rounded corners on panels (16px)

### B3. Animations & Interactions

**Page/Scroll:**
- Smooth scroll behavior (native)
- Chapter transition: Fade in, 300ms
- Progress bar: Width animation, 100ms

**Branch Switch:**
- Content cross-fade: 400ms
- Position restore: Animated scroll to equivalent point
- Back navigation: Slide from left indicator

**UI Interactions:**
- TOC drawer: Slide in from left, 300ms ease-out
- Settings panel: Slide up from bottom (mobile), modal (desktop)
- Branch panel: Expand/collapse with height animation
- Bookmark: Star fills with pop animation

**Focus Mode:**
- Paragraphs fade in on scroll
- Active paragraph: Full opacity
- Inactive: Slight dim (0.7 opacity)
- Transition: 200ms opacity change

**Reading Gestures:**
| Gesture | Action |
|---------|--------|
| Scroll | Navigate content |
| Swipe left | Next chapter |
| Swipe right | Previous chapter |
| Tap center | Toggle UI visibility |
| Tap edge (manga mode) | Page turn |
| Long press | Text selection / AI assist |

**Keyboard Shortcuts:**
| Key | Action |
|-----|--------|
| `Space` / `Page Down` | Scroll down |
| `Shift+Space` / `Page Up` | Scroll up |
| `J` / `â†“` | Next paragraph/scroll |
| `K` / `â†‘` | Previous paragraph/scroll |
| `â†’` | Next chapter |
| `â†` | Previous chapter |
| `B` | Toggle branch panel |
| `T` | Toggle TOC |
| `F` | Toggle focus mode |
| `S` | Open settings |
| `M` | Toggle bookmark |

---

## C. Data & State Management

### C1. Data Requirements

**Input Data:**
```typescript
interface StoryContent {
  storyId: string;
  branchId: string;
  chapters: Chapter[];
  metadata: {
    title: string;
    author: string;
    totalChapters: number;
    estimatedReadTime: number;
  };
}

interface Chapter {
  id: string;
  number: number;
  title: string;
  content: string; // HTML or structured content
  wordCount: number;
  estimatedReadTime: number;
  anchorPoint?: {
    anchorId: string;
    description: string;
  };
}

interface ReadingProgress {
  storyId: string;
  branchId: string;
  chapterId: string;
  scrollPosition: number; // Percentage or pixels
  scrollPercentage: number;
  lastReadAt: Date;
  totalTimeSpent: number; // seconds
  isCompleted: boolean;
}

interface ReadingPreferences {
  fontFamily: 'system' | 'serif' | 'sans-serif' | 'monospace';
  fontSize: 'small' | 'medium' | 'large' | 'xl';
  lineHeight: 'compact' | 'normal' | 'spacious';
  theme: 'light' | 'dark' | 'sepia' | 'auto';
  readingMode: 'scroll' | 'manga' | 'focus';
  // Per-story overrides
  storyOverrides: Record<string, Partial<ReadingPreferences>>;
}

interface BranchNavigation {
  currentBranchId: string;
  availableBranches: {
    id: string;
    name: string;
    description: string;
    color: string;
    isOriginal: boolean;
  }[];
  branchHistory: string[]; // Stack for back navigation
}
```

### C2. State Management

**Zustand Store:**
```typescript
interface StoryReaderStore {
  // Content
  currentStory: StoryContent | null;
  currentChapter: Chapter | null;
  
  // Reading state
  progress: ReadingProgress;
  isLoading: boolean;
  
  // UI state
  showTOC: boolean;
  showBranchPanel: boolean;
  showSettings: boolean;
  uiVisible: boolean;
  
  // Preferences
  preferences: ReadingPreferences;
  
  // Branch navigation
  branchNav: BranchNavigation;
  
  // Actions
  loadChapter: (chapterId: string) => Promise<void>;
  updateProgress: (scrollPosition: number) => void;
  nextChapter: () => void;
  previousChapter: () => void;
  switchBranch: (branchId: string) => Promise<void>;
  goBackInBranchHistory: () => void;
  toggleBookmark: () => void;
  updatePreferences: (prefs: Partial<ReadingPreferences>) => void;
  toggleUI: () => void;
}
```

**Persistence:**
- Progress saved to IndexedDB every 5 seconds
- Preferences saved immediately on change
- Branch history in session storage

---

## D. Performance & Optimization

### D1. Rendering Strategy

**Virtualization:**
- Long chapters: Virtual scroll for 10k+ words
- TOC: Virtualize if > 100 chapters
- Branch panel: No virtualization (limited items)

**Lazy Loading:**
- Chapter content loaded on demand
- Next chapter preloaded at 80% of current
- Previous chapter cached

**Content Optimization:**
- HTML sanitization for security
- Image lazy loading in content
- Font preloading for selected font

### D2. Smooth Scrolling

**Scroll Performance:**
- Passive scroll listeners
- RAF-based progress updates (throttled)
- Debounced progress saves

**Scroll Restoration:**
- Save exact position on navigation
- Restore with animated scroll
- Fallback to percentage if content changed

### D3. Performance Targets

| Metric | Target |
|--------|--------|
| Chapter Load | < 500ms |
| Scroll Performance | 60fps |
| Branch Switch | < 800ms |
| Settings Apply | < 100ms |
| Prefetch Next Chapter | < 2s |

---

## E. Error Handling & Edge Cases

### E1. Chapter Load Failure
- State: "Failed to load chapter" with retry
- Fallback: Load previous chapter position
- Log error for debugging

### E2. Missing Content
- "This chapter is empty"
- Option to regenerate or report
- Skip to next available chapter

### E3. Very Long Chapters (>30 min read)
- Warning: "Long chapter - take breaks!"
- Auto-save progress more frequently
- Reading session reminders

### E4. Branch Switch Data Loss
- Confirm if unsaved progress in current branch
- Option to save position or discard
- Visual indicator of "read" vs "unread" branches

### E5. Storage Full
- Warn when approaching limit
- Offer to export/archive old stories
- Continue reading without saving progress

### E6. Font Loading Failure
- Fallback to system fonts immediately
- Retry font load in background
- Notification of font change

---

## Feature Summary

| ID | Feature | Priority | Est. Hours |
|----|---------|----------|------------|
| F1 | Vertical scroll reading mode | P0 | 8 |
| F2 | Chapter navigation | P0 | 6 |
| F3 | Reading progress tracking | P0 | 8 |
| F4 | Branch switching panel | P0 | 10 |
| F5 | Table of contents drawer | P1 | 6 |
| F6 | Typography preferences | P1 | 8 |
| F7 | Theme support (light/dark/sepia) | P1 | 6 |
| F8 | Manga RTL mode | P2 | 10 |
| F9 | Focus mode | P2 | 8 |
| F10 | Bookmarking | P1 | 4 |
| F11 | Reading statistics | P2 | 6 |
| F12 | AI assistant panel | P2 | 8 |
| F13 | Keyboard shortcuts | P2 | 4 |
| F14 | Accessibility (screen reader) | P1 | 10 |

## Effort Estimate

**Total Estimated Hours: 112 hours**

**Breakdown:**
- Core reading experience: 30 hours
- Navigation and progress: 24 hours
- Branch integration: 18 hours
- Customization features: 18 hours
- Alternative reading modes: 14 hours
- Testing and refinement: 8 hours
