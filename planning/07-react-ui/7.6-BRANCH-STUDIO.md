# 7.6 Branch Studio

## Overview
The Branch Studio is the creative workspace where users generate, compare, refine, and select narrative branches. It provides a powerful side-by-side comparison interface for evaluating different story directions, along with tools to edit and customize branch premises before generating full continuations.

**User Value:** Compare multiple story directions simultaneously, edit branch premises for personalization, visualize branch relationships, seamless transition to story generation.

**Key Interactions:** Side-by-side comparison view, branch tree navigation, premise editing with AI assistance, rating and selection, direct continuation workflow.

---

## A. Core Functionality Questions

### A1. What is the primary generation workflow?
- [ ] Option A: Generate single branch, review, then generate more
- [ ] Option B: Batch generate multiple, then compare all
- [ ] Option C: Generate incrementally with feedback loop
- [ ] Option D: Guided generation (AI asks clarifying questions)
- [ ] Option E: Template-based with user customization

**Decision:** **B + C** — Batch generate 3-5 branches initially, then iterative refinement based on user feedback.

### A2. How should branch comparison be presented?
- [ ] Option A: Horizontal carousel/swipe
- [ ] Option B: Vertical stack with expand/collapse
- [ ] Option C: Side-by-side 2-3 column grid
- [ ] Option D: Tree visualization with preview
- [ ] Option E: Full-screen overlay comparison

**Decision:** **C + D** — Default 2-3 column comparison grid with optional tree view for relationship visualization.

### A3. What can users edit in generated branches?
- [ ] Option A: Nothing (select only)
- [ ] Option B: Premise/title only
- [ ] Option C: Full outline editing
- [ ] Option D: Character focus and tone
- [ ] Option E: Regenerate with feedback prompts

**Decision:** **B + D + E** — Edit premise and creative direction (tone, focus), regenerate with natural language feedback.

### A4. How should branch relationships be visualized?
- [ ] Option A: Simple list with parent reference
- [ ] Option B: Tree diagram (dendrogram)
- [ ] Option C: Network graph showing similarities
- [ ] Option D: Timeline with branch points
- [ ] Option E: Nested folder structure

**Decision:** **B + C** — Tree view for hierarchy, network view for similarity exploration.

### A5. What happens after branch selection?
- [ ] Option A: Immediate redirect to story generation
- [ ] Option B: Stay in studio, enable "Continue Story" action
- [ ] Option C: Preview estimated chapter outline
- [ ] Option D: Branch details modal with confirmation
- [ ] Option E: Queue for later generation

**Decision:** **B + C + D** — Selection enables continue action, shows preview outline, confirms before proceeding.

### A6. How to handle branch variations (same premise, different executions)?
- [ ] Option A: Don't support variations
- [ ] Option B: Group variations under parent branch
- [ ] Option C: Flat list with similarity indicators
- [ ] Option D: Show only best variation
- [ ] Option E: Variations as refinement step

**Decision:** **B + E** — Group variations, allow refinement to generate more from selected direction.

---

## B. UI/UX Specifications

### B1. Layout & Structure

**Primary Layout - Comparison Mode:**
```
┌─────────────────────────────────────────────────────────────────────┐
│  [Back]  Branch Studio: "What if..."                    [Tree View] │
│  [Anchor: Chapter 5 - The Decision]                                 │
├─────────────────────────────────────────────────────────────────────┤
│  Generation Settings: [Tone: Dark ▼] [Focus: Character A ▼] [Count: 3▼]│
├─────────────────────────────────────────────────────────────────────┤
│  ┌────────────────┐  ┌────────────────┐  ┌────────────────┐        │
│  │  BRANCH A      │  │  BRANCH B      │  │  BRANCH C      │        │
│  │  ⭐ Selected   │  │                │  │                │        │
│  │                │  │                │  │                │        │
│  │  [Premise      │  │  [Premise      │  │  [Premise      │        │
│  │   Title]       │  │   Title]       │  │   Title]       │        │
│  │                │  │                │  │                │        │
│  │  Brief         │  │  Brief         │  │  Brief         │        │
│  │  description   │  │  description   │  │  description   │        │
│  │  of the        │  │  of the        │  │  of the        │        │
│  │  direction...  │  │  direction...  │  │  direction...  │        │
│  │                │  │                │  │                │        │
│  │  [Edit] [Regen]│  │  [Edit] [Regen]│  │  [Edit] [Regen]│        │
│  │                │  │                │  │                │        │
│  │  [⭐ Select]   │  │  [⭐ Select]   │  │  [⭐ Select]   │        │
│  └────────────────┘  └────────────────┘  └────────────────┘        │
├─────────────────────────────────────────────────────────────────────┤
│  [+ Generate More]  [Compare Selected (2)]  [Continue Selected →]   │
└─────────────────────────────────────────────────────────────────────┘
```

**Tree View Layout:**
```
┌─────────────────────────────────────────────────────────────────────┐
│  Story Tree                                    [Comparison View]    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│                         [Original]                                  │
│                            │                                        │
│                    [Anchor: Ch.5]                                   │
│                      /     │     \                                  │
│                   ┌──┐   ┌──┐   ┌──┐                                │
│                   │A │   │B │   │C │                                │
│                   └──┘   │  │   └──┘                                │
│                         /    \                                      │
│                      ┌──┐   ┌──┐                                    │
│                      │B1│   │B2│  (variations)                      │
│                      └──┘   └──┘                                    │
│                                                                     │
│  [Selected: B → B2]                      [Continue from B2 →]       │
└─────────────────────────────────────────────────────────────────────┘
```

### B2. Visual Design

**Branch Cards:**
- White card with subtle shadow (Apple-style elevation)
- Selected state: Blue border (2px), light blue background tint
- Hover: Lift effect (translateY -2px), enhanced shadow
- Card height: Flexible based on content, max 400px
- Sections: Title, premise summary, key events preview, actions

**Selection States:**
- Unselected: Default card styling
- Selected: Full ring highlight, checkmark badge
- Comparing: Side indicators (A, B, C labels)
- Favorite: Star icon in corner

**Generation Settings Panel:**
- Collapsible section above comparison
- Tone selector: Chip group (Dark, Light, Neutral, Tragic, Hopeful)
- Focus selector: Character dropdown + relationship toggle
- Count slider: 1-5 branches
- Advanced: Expandable for detailed parameters

**Tree Visualization:**
- Nodes as rounded rectangles
- Original story: Gray, solid
- Anchor point: Diamond shape, accent color
- Branches: Color-coded by tone/type
- Active path: Highlighted with animated flow line
- Zoom and pan controls

**Apple Aesthetic:**
- Cards float on background (layered depth)
- Generous spacing between comparison items (24px)
- Typography: Title 2 for branch names, Body for content
- Accent blue for primary actions and selections

### B3. Animations & Interactions

**Card Interactions:**
- Hover: 200ms ease-out, scale 1.01, shadow increase
- Selection: 300ms spring animation, border draws in
- Edit mode: Card expands, form fields fade in
- Generation: Skeleton loading state, content streams in

**Generation Animation:**
- Cards appear with stagger (100ms between)
- Content types in (optional, subtle)
- "Thinking" state: Pulsing gradient background
- Complete: Subtle success animation

**Comparison Mode:**
- Switch view: Cross-fade 250ms
- Column resize: Smooth flex transition
- Scroll sync: Optional synchronized scrolling

**Tree View:**
- Node expand: Branch lines draw outward, 400ms
- Pan/zoom: Momentum with 60fps target
- Path highlight: Animated dashed line flow

**Keyboard Shortcuts:**
| Key | Action |
|-----|--------|
| `1-5` | Select branch N |
| `E` | Edit selected branch |
| `R` | Regenerate selected |
| `C` | Continue with selected |
| `T` | Toggle tree/comparison view |
| `G` | Generate more branches |
| `←/→` | Navigate between branches |

---

## C. Data & State Management

### C1. Data Requirements

**Input Data:**
```typescript
interface BranchStudioSession {
  id: string;
  mangaId: string;
  anchorId: string;
  createdAt: Date;
  settings: GenerationSettings;
}

interface GenerationSettings {
  tone: 'dark' | 'light' | 'neutral' | 'tragic' | 'hopeful' | 'suspenseful';
  characterFocus?: string[];
  themeEmphasis?: string[];
  count: number;
  constraints?: {
    avoidTropes?: string[];
    includeElements?: string[];
    maxDivergence?: 'subtle' | 'moderate' | 'extreme';
  };
}

interface Branch {
  id: string;
  sessionId: string;
  index: number; // A, B, C, etc.
  premise: {
    title: string;
    summary: string;
    hook: string;
  };
  outline: StoryOutline;
  metadata: {
    generatedAt: Date;
    tone: string;
    confidence: number;
    estimatedChapters: number;
  };
  parentBranchId?: string; // For variations
  variations?: Branch[];
  userEdits?: {
    editedPremise?: string;
    feedback?: string;
    rating?: 1-5;
  };
}

interface StoryOutline {
  chapters: {
    number: number;
    title: string;
    summary: string;
    keyScenes: string[];
  }[];
  characterArcs: {
    characterId: string;
    arc: string;
  }[];
}
```

### C2. State Management

**Zustand Store:**
```typescript
interface BranchStudioStore {
  // Session
  session: BranchStudioSession | null;
  branches: Branch[];
  
  // Selection
  selectedBranchId: string | null;
  comparingBranchIds: string[];
  
  // View state
  viewMode: 'comparison' | 'tree';
  editedBranchId: string | null;
  isGenerating: boolean;
  generationProgress: number;
  
  // Editing
  draftEdits: {
    branchId: string;
    premise?: string;
    settings?: Partial<GenerationSettings>;
  } | null;
  
  // Actions
  setViewMode: (mode: 'comparison' | 'tree') => void;
  selectBranch: (id: string | null) => void;
  toggleComparison: (id: string) => void;
  startEditing: (id: string) => void;
  saveEdits: () => Promise<void>;
  generateBranches: (settings: GenerationSettings) => Promise<void>;
  regenerateBranch: (id: string, feedback: string) => Promise<void>;
  createVariation: (parentId: string) => Promise<void>;
  continueWithBranch: (id: string) => void;
}
```

---

## D. Performance & Optimization

### D1. Rendering Strategy

**Virtualization:**
- Comparison grid: No virtualization needed (max 5 items)
- Tree view: Virtualize nodes if > 50 branches
- Outline preview: Virtualize chapter list

**Lazy Loading:**
- Full outline loaded on demand (selection)
- Variations collapsed by default
- Tree node details on expand

### D2. Generation State Management

**Optimistic UI:**
- Show skeleton cards immediately on generation start
- Stream content as it arrives
- Progressive enhancement of card content

**Cancellation:**
- Support aborting generation mid-stream
- Partial results preserved
- "Stop generating" button during active generation

### D3. Performance Targets

| Metric | Target |
|--------|--------|
| Initial Load | < 600ms |
| View Switch | < 200ms |
| Card Hover | 60fps |
| Generation Start | < 500ms |
| First Content | < 3s |
| Full Generation | < 15s for 3 branches |
| Edit Mode Open | < 150ms |

---

## E. Error Handling & Edge Cases

### E1. Generation Failure
- State: "Generation failed" with error details
- Options: Retry with same settings | Modify settings | Cancel
- Partial results: Show any completed branches

### E2. Low Quality Results
- User feedback: "Not satisfied with results?"
- Suggest: Adjust tone, add constraints, or provide feedback
- One-click "Try different approach"

### E3. Too Many Branches (>20)
- Warning: "Many branches may impact performance"
- Suggest: Archive old branches, use folders
- Pagination or virtual scrolling

### E4. Branch Conflicts
- Detect similar branches
- Suggest: Merge or differentiate
- Similarity indicator on cards

### E5. Storage Limitations
- Check available storage before generation
- Warning if approaching limit
- Offer: Export old branches, clean up

### E6. Edit Conflicts
- Warn if regenerating edited branch
- Option: Preserve edits or reset
- Version history for branches

---

## Feature Summary

| ID | Feature | Priority | Est. Hours |
|----|---------|----------|------------|
| F1 | Comparison grid view (2-3 columns) | P0 | 10 |
| F2 | Branch generation with settings | P0 | 12 |
| F3 | Branch card with premise display | P0 | 8 |
| F4 | Tree visualization mode | P1 | 10 |
| F5 | Premise editing interface | P1 | 8 |
| F6 | Branch selection workflow | P1 | 6 |
| F7 | Regenerate with feedback | P1 | 8 |
| F8 | Variation grouping | P2 | 6 |
| F9 | Continue to story generation | P1 | 4 |
| F10 | Generation settings panel | P2 | 6 |
| F11 | Outline preview | P2 | 6 |
| F12 | Keyboard shortcuts | P2 | 4 |
| F13 | Accessibility support | P1 | 8 |

## Effort Estimate

**Total Estimated Hours: 106 hours**

**Breakdown:**
- Core comparison view: 28 hours
- Generation workflow: 26 hours
- Tree visualization: 16 hours
- Editing features: 14 hours
- Data integration: 14 hours
- Testing and refinement: 8 hours
