# 7.8 Settings Panel

## Overview
The Settings Panel provides comprehensive configuration management for The Loom 2, including LLM provider setup with encrypted API key storage, analysis quality preferences, appearance settings, and accessibility options. Designed for both novice and power users with progressive disclosure of advanced features.

**User Value:** Secure API key management, personalized analysis preferences, comfortable reading environment, control over data and privacy.

**Key Interactions:** Secure key input with encryption, preference toggles, theme selection, data export/import, storage management.

---

## A. Core Functionality Questions

### A1. How should settings be organized?
- [ ] Option A: Single long page with sections
- [ ] Option B: Sidebar navigation with categories
- [ ] Option C: Tabbed interface
- [ ] Option D: Search-first with filterable settings
- [ ] Option E: Card-based grid of setting groups

**Decision:** **B + D** â€” Sidebar categories for browsing, search bar for quick access, categories: General, LLM Providers, Analysis, Appearance, Data, Advanced.

### A2. How should API keys be secured?
- [ ] Option A: Plain text in localStorage
- [ ] Option B: Encrypted with user password
- [ ] Option C: Browser native credential management
- [ ] Option D: Encryption with device-bound key
- [ ] Option E: Optional local-only, no cloud sync

**Decision:** **D + E** â€” AES-256 encryption with device-derived key, local-only storage, no cloud sync ever.

### A3. What LLM provider options should be supported?
- [ ] Option A: Single provider (OpenAI only)
- [ ] Option B: OpenAI + Anthropic
- [ ] Option C: Major providers + local models
- [ ] Option D: Custom endpoint configuration
- [ ] Option E: Multiple active providers with fallback

**Decision:** **B + C + D** â€” OpenAI and Anthropic as primary, local model support (Ollama), custom endpoint for power users.

### A4. How should analysis quality preferences work?
- [ ] Option A: Simple slider (Fast/Balanced/Thorough)
- [ ] Option B: Granular controls per analysis stage
- [ ] Option C: Preset profiles (Quick/Standard/Deep)
- [ ] Option D: Token/cost limit configuration
- [ ] Option E: Time-based limits

**Decision:** **A + C + D** â€” Simple slider as default, advanced preset profiles, optional token limits for cost control.

### A5. What accessibility options are required?
- [ ] Option A: None (default browser support)
- [ ] Option B: Font size only
- [ ] Option C: Full WCAG compliance (contrast, motion, focus)
- [ ] Option D: Screen reader optimization
- [ ] Option E: All of the above plus customization

**Decision:** **E** â€” Full WCAG 2.1 AA compliance with user customization for specific needs.

### A6. How should data management be handled?
- [ ] Option A: No user control (automatic)
- [ ] Option B: Basic export only
- [ ] Option C: Full export/import with formats
- [ ] Option D: Selective data deletion
- [ ] Option E: Storage analysis and cleanup tools

**Decision:** **C + D + E** â€” Complete data portability, granular deletion, storage management dashboard.

---

## B. UI/UX Specifications

### B1. Layout & Structure

**Primary Layout:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [Back]  Settings                                       [Search ğŸ”] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                 â”‚                                                   â”‚
â”‚  GENERAL        â”‚   Setting Category Title                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                           â”‚
â”‚  LLM Providers  â”‚                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  Analysis       â”‚   â”‚ Setting Name                    [Toggle] â”‚    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚ Description text goes here...             â”‚    â”‚
â”‚  Appearance     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                                                   â”‚
â”‚  Data & Privacy â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚ Another Setting               [Dropdownâ–¼]â”‚    â”‚
â”‚  Accessibility  â”‚   â”‚                                          â”‚    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  Advanced       â”‚                                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚                 â”‚   â”‚ API Key                          [â€¢â€¢â€¢â€¢] â”‚    â”‚
â”‚                 â”‚   â”‚ [Reveal] [Delete]                       â”‚    â”‚
â”‚                 â”‚   â”‚ Status: Connected âœ“                     â”‚    â”‚
â”‚                 â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                 â”‚                                                   â”‚
â”‚                 â”‚   [Save Changes]        [Reset to Defaults]       â”‚
â”‚                 â”‚                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Category Breakdown:**

1. **General:**
   - Language selection
   - Startup behavior
   - Update preferences
   - Crash reporting (opt-in)

2. **LLM Providers:**
   - Provider cards with status
   - Encrypted API key input
   - Model selection
   - Connection test
   - Usage statistics

3. **Analysis:**
   - Quality/depth slider
   - Default analysis preferences
   - Parallel processing limit
   - Timeout settings

4. **Appearance:**
   - Theme selection (Light/Dark/Auto)
   - Accent color picker
   - Density preference
   - Animation toggle

5. **Data & Privacy:**
   - Export data
   - Import data
   - Storage usage
   - Delete specific data types
   - Clear all data

6. **Accessibility:**
   - Font size scaling
   - High contrast mode
   - Reduce motion
   - Focus indicators
   - Screen reader hints

7. **Advanced:**
   - Debug mode
   - Custom CSS
   - Keyboard shortcut overrides
   - Experimental features

### B2. Visual Design

**Settings Cards:**
- White background, 1px border (#e5e5e5)
- Padding: 16px 20px
- Border-radius: 12px
- Shadow on hover (subtle)
- Group related settings with dividers

**Interactive Elements:**
- Toggles: iOS-style, 50px width, smooth slide
- Inputs: 44px height, rounded 8px, focus ring
- Dropdowns: Native-styled custom select
- Buttons: Pill shape, 36px height

**API Key Input:**
- Masked by default (â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢)
- Reveal button (eye icon)
- Delete button (trash icon)
- Status indicator below
- Test connection button

**Progress/Status:**
- Saving: Subtle spinner
- Saved: Checkmark with "Saved" text
- Error: Red alert with retry

**Apple Aesthetic:**
- Clean separation between categories
- Grouped settings with clear hierarchy
- Toggle switches mimic iOS design
- Consistent 16px grid alignment

### B3. Animations & Interactions

**Navigation:**
- Category switch: Content fade, 200ms
- Search: Results filter with stagger, 50ms
- Smooth scroll to setting on deep link

**Input Interactions:**
- Toggle: 200ms spring animation
- Input focus: Border color transition, 150ms
- Button press: Scale 0.98, 100ms
- Dropdown: Slide down + fade, 200ms

**Feedback:**
- Save success: Subtle green flash on setting
- Error: Shake animation on invalid input
- API test: Loading â†’ Success/Error transition

**Modal Dialogs:**
- Dangerous actions (delete): Confirmation modal
- Export/Import: Slide-up panel
- Reset: Full-screen warning overlay

**Keyboard Navigation:**
| Key | Action |
|-----|--------|
| `Tab` | Navigate settings |
| `Space` | Toggle checkbox/switch |
| `Enter` | Activate button/open dropdown |
| `â†‘/â†“` | Navigate dropdown options |
| `Esc` | Close dropdown/cancel |
| `âŒ˜/Ctrl + F` | Focus search |

---

## C. Data & State Management

### C1. Data Requirements

**Settings Schema:**
```typescript
interface AppSettings {
  // General
  general: {
    language: string;
    startupBehavior: 'library' | 'lastOpen' | 'welcome';
    checkForUpdates: boolean;
    autoUpdate: boolean;
    crashReporting: boolean;
  };

  // LLM Providers
  llmProviders: {
    providers: LLMProviderConfig[];
    defaultProvider: string;
  };

  // Analysis
  analysis: {
    qualityLevel: 'fast' | 'balanced' | 'thorough' | 'custom';
    customSettings?: {
      characterDepth: number;
      timelineGranularity: 'chapter' | 'scene' | 'page';
      themeAnalysis: boolean;
      relationshipMapping: boolean;
      maxTokensPerChapter: number;
    };
    parallelLimit: number;
    timeoutSeconds: number;
  };

  // Appearance
  appearance: {
    theme: 'light' | 'dark' | 'auto';
    accentColor: string;
    density: 'compact' | 'comfortable' | 'spacious';
    animations: boolean;
    sidebarCollapsed: boolean;
  };

  // Data & Privacy
  data: {
    autoBackup: boolean;
    backupFrequency: 'daily' | 'weekly' | 'monthly';
    maxStorageGB: number;
  };

  // Accessibility
  accessibility: {
    fontScale: number;
    highContrast: boolean;
    reduceMotion: boolean;
    enhancedFocus: boolean;
    screenReaderHints: boolean;
  };

  // Advanced
  advanced: {
    debugMode: boolean;
    experimentalFeatures: string[];
    customCSS: string;
    keyboardOverrides: Record<string, string>;
  };
}

interface LLMProviderConfig {
  id: string;
  name: string;
  type: 'openai' | 'anthropic' | 'ollama' | 'custom';
  apiKey?: string; // Encrypted
  endpoint?: string;
  defaultModel: string;
  availableModels: string[];
  isEnabled: boolean;
  usageStats: {
    requestsThisMonth: number;
    tokensThisMonth: number;
    estimatedCost: number;
  };
}
```

**Encrypted Storage:**
```typescript
interface EncryptedStorage {
  // Encryption
  algorithm: 'AES-256-GCM';
  keyDerivation: 'PBKDF2';
  salt: string;
  
  // API Keys stored encrypted
  encryptedKeys: {
    providerId: string;
    encryptedKey: string;
    iv: string;
    tag: string;
  }[];
}
```

### C2. State Management

**Zustand Store:**
```typescript
interface SettingsStore {
  // Settings data
  settings: AppSettings;
  originalSettings: AppSettings; // For change detection
  
  // UI state
  activeCategory: string;
  searchQuery: string;
  isSaving: boolean;
  lastSaved: Date | null;
  unsavedChanges: boolean;
  
  // Modal states
  showResetConfirm: boolean;
  showDeleteConfirm: boolean;
  showExportPanel: boolean;
  
  // Actions
  setActiveCategory: (category: string) => void;
  updateSetting: (path: string, value: any) => void;
  saveSettings: () => Promise<void>;
  resetSettings: () => void;
  exportData: (format: 'json' | 'csv') => Promise<Blob>;
  importData: (file: File) => Promise<void>;
  deleteData: (type: string) => Promise<void>;
  testConnection: (providerId: string) => Promise<boolean>;
  setApiKey: (providerId: string, key: string) => Promise<void>;
}
```

---

## D. Performance & Optimization

### D1. Settings Persistence

**Auto-Save Strategy:**
- Debounced save: 500ms after last change
- Immediate save for critical settings (API keys)
- Background sync indicator
- Conflict resolution for simultaneous changes

**Change Detection:**
- Deep comparison with original settings
- Visual indicator for unsaved changes
- Confirm on navigate away if unsaved

### D2. Encryption Performance

**Key Derivation:**
- Cache derived key in memory (securely)
- Re-derive only on app restart
- Async encryption to avoid blocking UI

**API Key Operations:**
- Encrypt on blur (not on every keystroke)
- Decrypt only when needed (test connection)
- Mask in UI, never show full key after entry

### D3. Performance Targets

| Metric | Target |
|--------|--------|
| Settings Load | < 200ms |
| Save Settings | < 500ms |
| Category Switch | < 150ms |
| Search Filter | < 100ms |
| Encryption | < 100ms |
| API Test | < 3s |

---

## E. Error Handling & Edge Cases

### E1. Invalid API Key
- Error: "Connection failed - check your API key"
- Action: Highlight key input, show test result
- Help: Link to provider documentation

### E2. Settings Save Failure
- Error: "Failed to save settings"
- Retry: Automatic retry Ã— 3
- Fallback: Download settings as file
- Notification: Persistent until resolved

### E3. Import Validation Failure
- Validate schema before import
- Show specific validation errors
- Partial import option for valid data
- Backup current settings before import

### E4. Storage Full
- Warning: "Settings cannot be saved - storage full"
- Action: Link to data management
- Emergency: Save critical settings only

### E5. Encryption Key Loss
- Scenario: User clears browser data
- Result: API keys lost, must re-enter
- Prevention: Warning before destructive actions
- Recovery: None (by design for security)

### E6. Concurrent Settings Changes
- Detect multiple app instances
- Last-write-wins with notification
- Offer: Merge settings option

---

## Feature Summary

| ID | Feature | Priority | Est. Hours |
|----|---------|----------|------------|
| F1 | Category sidebar navigation | P0 | 6 |
| F2 | Search and filter settings | P0 | 6 |
| F3 | Encrypted API key storage | P0 | 12 |
| F4 | LLM provider configuration | P0 | 10 |
| F5 | Connection testing | P1 | 4 |
| F6 | Analysis quality preferences | P1 | 6 |
| F7 | Theme and appearance | P1 | 6 |
| F8 | Data export/import | P1 | 8 |
| F9 | Storage management | P2 | 6 |
| F10 | Accessibility settings | P1 | 8 |
| F11 | Advanced settings | P2 | 6 |
| F12 | Auto-save and change detection | P1 | 6 |
| F13 | Keyboard navigation | P2 | 4 |

## Effort Estimate

**Total Estimated Hours: 98 hours**

**Breakdown:**
- Core settings framework: 22 hours
- LLM provider management: 24 hours
- Security and encryption: 16 hours
- Data management: 14 hours
- Appearance and accessibility: 12 hours
- Testing and refinement: 10 hours
