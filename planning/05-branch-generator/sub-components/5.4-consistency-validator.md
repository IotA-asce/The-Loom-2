# Sub-Component 5.4: Consistency Validator

## Purpose
Validate that generated branches maintain narrative consistency — checking that characters act believably, world rules are followed, and the narrative style matches the original.

---

## Requirements Gathering

### Question 1: Consistency Strictness

**How strict should consistency checking be?**

Options:
- **A. Strict:** Any deviation from established character = reject
- **B. Moderate:** Allow growth within established bounds
- **C. Lenient:** Only flag major contradictions
- **D. Context-aware:** Stricter for core traits, flexible for minor
- **E. Branch-appropriate:** Allow deviation if branch justifies it

Considerations:
- Strict = safe but may reject creative branches
- Lenient = more variety but risk OOC moments
- Branches may intentionally explore character change

### Question 2: Character Growth vs. Derailment

**Should we allow character growth/deviation from original?**

Options:
- **A. No deviation:** Characters act exactly as established
- **B. Natural growth:** Allow development that makes sense
- **C. Branch-driven:** Different branches = different growth paths
- **D. User control:** User specifies how much deviation allowed

Considerations:
- Branches often explore "what if character changes"
- But should feel earned, not arbitrary
- Trauma, success, failure can change people

### Question 3: Hard vs. Soft World Rules

**What world elements are "hard rules" vs. flexible?**

Options:
- **A. All hard:** All established world rules must be followed
- **B. Core hard:** Fundamental rules only (magic system, physics)
- **C. Social soft:** Social norms can shift in branches
- **D. Explicit hard:** Only explicitly stated rules are hard
- **E. Branch-aware:** Rules can evolve if branch justifies

Considerations:
- Some world elements define the setting
- Others may be societal and can change
- Magic systems usually hard, culture may be soft

### Question 4: Inconsistency Handling

**Should we auto-fix inconsistencies or flag for review?**

Options:
- **A. Auto-fix:** AI corrects inconsistencies automatically
- **B. Flag only:** Mark for user review, don't change
- **C. Suggest fixes:** Offer corrections, user approves
- **D. Severity-based:** Auto-fix minor, flag major
- **E. Learning-based:** Track what user typically fixes

Considerations:
- Auto-fix fast but may lose intent
- User review slower but preserves agency
- Balance efficiency and control

### Question 5: Validation Dimensions

**What dimensions should be validated?**

Rank by importance:
- Character personality/actions
- Character knowledge (don't know what they shouldn't)
- World rules/physics
- Relationship dynamics
- Narrative tone/voice
- Genre conventions
- Timeline continuity (no impossible sequences)
- Power levels/capabilities

### Question 6: Validation Trigger

**When should validation occur?**

Options:
- **A. Post-generation:** After branches complete
- **B. Per-branch:** As each branch generated
- **C. Streaming:** Validate as LLM generates
- **D. User-triggered:** Only when user requests
- **E. Continuous:** Background validation during generation

Considerations:
- Earlier = faster feedback
- Later = complete picture for validation
- May want both (quick + thorough)

---

## Technical Considerations

### Consistency Check Framework

```typescript
interface ConsistencyValidator {
  // Main validation
  validate(branch: Branch, context: BranchContext): ValidationReport;
  
  // Component validators
  validateCharacterConsistency(branch: Branch, characters: Character[]): CharacterValidation;
  validateWorldConsistency(branch: Branch, world: WorldState): WorldValidation;
  validateRelationshipConsistency(branch: Branch, relationships: Relationship[]): RelationshipValidation;
  validateToneConsistency(branch: Branch, narrativeStyle: NarrativeStyle): ToneValidation;
}

interface ValidationReport {
  valid: boolean;
  overallScore: number;  // 0-1
  
  // By category
  characterScore: number;
  worldScore: number;
  relationshipScore: number;
  toneScore: number;
  
  // Issues found
  issues: ConsistencyIssue[];
  
  // Recommendations
  suggestions: string[];
}

interface ConsistencyIssue {
  id: string;
  severity: 'critical' | 'major' | 'minor' | 'info';
  category: 'character' | 'world' | 'relationship' | 'tone';
  description: string;
  location: string;  // Where in branch
  suggestion: string;
  autoFixable: boolean;
}
```

---

## Decisions Recorded

| Question | Decision | Rationale |
|----------|----------|-----------|
| 1. Consistency Strictness | **D. Context-aware** | Strict for core traits, flexible for minor |
| 2. Character Growth | **D. User control** | User specifies how much deviation allowed |
| 3. Hard/Soft Rules | **C. Social soft** | Social norms can shift, core rules stay |
| 4. Inconsistency Handling | **C. Suggest fixes** | Offer corrections, user approves |
| 5. Validation Dimensions | **ALL are critical** | All 8 dimensions must be validated |
| 6. Validation Trigger | **D. User-triggered** | On-demand validation per user request |

### Context-Aware Validation Strictness

```typescript
interface ContextAwareValidation {
  // Core traits: Strict validation
  coreTraits: {
    examples: ['fundamental personality', 'core values', 'dee fears'],
    strictness: 'strict',  // No deviation allowed
    tolerance: 0.0
  };
  
  // Secondary traits: Moderate validation
  secondaryTraits: {
    examples: ['preferences', 'habits', 'communication style'],
    strictness: 'moderate',  // Growth allowed
    tolerance: 0.3
  };
  
  // Minor traits: Flexible validation
  minorTraits: {
    examples: ['temporary moods', 'surface behaviors'],
    strictness: 'flexible',  // Branch can shift
    tolerance: 0.6
  };
}

// Example:
// Core: Kira's protective nature (never changes)
// Secondary: Kira's comfort with violence (can evolve)
// Minor: Kira's current irritability (branch-dependent)
```

### User-Controlled Deviation Levels

```typescript
interface DeviationControl {
  // User selects before generation
  deviationLevel: 'canonical' | 'natural' | 'exploratory' | 'radical';
  
  levels: {
    canonical: {
      description: 'Characters act exactly as established',
      allowed: 'No deviation',
      useCase: 'Explore plot changes only'
    },
    natural: {
      description: 'Sensible growth and development',
      allowed: 'Realistic character evolution',
      useCase: 'Standard branch exploration'
    },
    exploratory: {
      description: 'Significant but justified changes',
      allowed: 'Major shifts if story-earned',
      useCase: 'What if character fundamentally changes?'
    },
    radical: {
      description: 'Dramatic reimagining',
      allowed: 'Even OOC if interesting',
      useCase: 'AUs and dramatic departures'
    }
  };
}
```

### Social Soft Rules

```typescript
interface WorldRuleClassification {
  // Hard rules: Never bend
  hardRules: [
    'Magic system mechanics',
    'Physics of the world',
    'Established history',
    'Character backstory facts',
    'Geographic facts'
  ];
  
  // Soft rules: Can shift in branches
  softRules: [
    'Social norms and customs',
    'Political structures',
    'Cultural attitudes',
    'Technological adoption',
    'Fashion and trends',
    'Popular opinions'
  ];
}

// Example:
// Hard: Magic requires sacrifice (world rule)
// Soft: Society accepts mages (can become persecuted in branch)
```

### Suggest-Fix Workflow

```typescript
interface SuggestedFix {
  issue: ConsistencyIssue;
  
  // AI-generated suggestion
  suggestion: {
    description: string;
    proposedChange: string;
    reasoning: string;
  };
  
  // User options
  userChoice: 'accept' | 'reject' | 'modify' | 'ignore';
  
  // If user modifies
  userModification?: string;
}

// Workflow:
// 1. Validation finds issue: "Kira acts too aggressive (inconsistent with protective nature)"
// 2. AI suggests: "Change to defensive stance instead of attacking"
// 3. User reviews:
//    [Accept] [Reject] [Modify] [Ignore]
// 4. If accepted: Branch updated
// 5. If rejected: Issue remains flagged
// 6. If modified: User edits suggestion
```

### Comprehensive 8-Dimension Validation

```typescript
interface ComprehensiveValidation {
  // All 8 dimensions validated
  dimensions: {
    characterPersonality: {
      weight: 0.20,
      checks: ['actions match traits', 'motivations consistent', 'growth earned']
    },
    characterKnowledge: {
      weight: 0.15,
      checks: ['dont know future', 'dont know others thoughts', 'limited perspective']
    },
    worldRules: {
      weight: 0.15,
      checks: ['magic system', 'physics', 'hard rules followed']
    },
    relationshipDynamics: {
      weight: 0.15,
      checks: ['status matches', 'evolution consistent', 'reciprocal feelings']
    },
    narrativeTone: {
      weight: 0.10,
      checks: ['voice matches', 'style consistent', 'genre conventions']
    },
    genreConventions: {
      weight: 0.10,
      checks: ['tropes appropriate', 'expectations met', 'innovation justified']
    },
    timelineContinuity: {
      weight: 0.10,
      checks: ['cause before effect', 'no impossible sequences', 'time consistent']
    },
    powerLevels: {
      weight: 0.05,
      checks: ['abilities match', 'no sudden powerups', 'consequences appropriate']
    }
  };
  
  // All must pass minimum threshold
  minimumThreshold: 0.7;  // 70% on each dimension
}
```

### User-Triggered Validation

```typescript
interface ValidationTrigger {
  // Default: No automatic validation
  autoValidate: false;
  
  // User triggers when ready
  triggerOptions: {
    quickCheck: 'Fast validation of critical issues only';
    fullValidation: 'Comprehensive 8-dimension check';
    customValidation: 'User selects which dimensions';
  };
  
  // Validation modes
  modes: {
    quick: {
      dimensions: ['characterPersonality', 'worldRules'],
      depth: 'surface',
      time: '< 5 seconds'
    },
    full: {
      dimensions: 'all',
      depth: 'deep',
      time: '10-30 seconds'
    }
  };
}

// User clicks "Validate Branch" button
// → Chooses quick or full
// → Sees results
// → Reviews suggestions
// → Approves/rejects fixes
```

---

## Status: ✅ Interrogation Complete

**Next: Sub-Component 5.5 — Branch Refiner**
