# Sub-Component 5.6: Branch Comparator

## Purpose
Enable comparison between branches and the original timeline — visualizing divergence, similarities, and impacts to help users choose which branches to explore.

---

## Requirements Gathering

### Question 1: Comparison Dimensions

**What comparison dimensions are most useful?**

Rank by importance:
- Character outcomes (who lives/dies/succeeds)
- Plot divergence (which events change)
- Emotional tone (optimistic vs tragic)
- Theme emphasis (which themes explored)
- Relationship changes (how dynamics shift)
- World state differences (setting changes)
- Pacing differences (faster/slower)
- Story length (shorter/longer arc)

### Question 2: Visualization Style

**How should comparison be visualized?**

Options:
- **A. Timeline diff:** Side-by-side timelines with divergence highlighted
- **B. Character impact matrix:** Characters × branches grid
- **C. Venn diagram:** Overlaps and unique elements
- **D. Tree diagram:** Branching tree from anchor point
- **E. Card comparison:** Side-by-side branch cards

Considerations:
- Timeline diff shows when things diverge
- Matrix good for character focus
- Tree shows relationships between branches
- Cards simplest but least detailed

### Question 3: Similarity Quantification

**How do we quantify "similarity" between branches?**

Options:
- **A. Event overlap:** % of events that are same/different
- **B. Character fate:** How many characters have same outcomes
- **C. Ending similarity:** How similar are endpoints
- **D. Trajectory similarity:** Path similarity, not just endpoints
- **E. Theme overlap:** How many themes in common
- **F. Composite score:** Weighted combination

Considerations:
- Two branches can have different paths but similar endings
- Or similar paths but different endings
- Need holistic similarity measure

### Question 4: "What Stays Same" Display

**Should comparison include "what stays the same"?**

Options:
- **A. No:** Focus only on differences
- **B. Brief mention:** Note major unchanged elements
- **C. Detailed:** Show both same and different explicitly
- **D. Toggle:** User can show/hide similarities

Considerations:
- Same elements provide context
- But may clutter comparison
- Toggle gives user control

### Question 5: Comparison Scope

**What scope of comparison should be shown?**

Options:
- **A. Immediate only:** Just around anchor point
- **B. Short-term:** Next few chapters
- **C. Full arc:** Complete story divergence
- **D. Adaptive:** User selects scope
- **E. Progressive:** Start immediate, expand on demand

Considerations:
- Full arc may be overwhelming
- Immediate may miss important divergence
- Progressive loading balances detail

### Question 6: Multi-Branch Comparison

**How many branches can be compared at once?**

Options:
- **A. Binary:** Original + 1 branch
- **B. Triptych:** Original + 2 branches
- **C. Quad:** Up to 4 branches
- **D. Unlimited:** All selected branches
- **E. Smart selection:** AI suggests most different branches

Considerations:
- More branches = more comparison power
- But harder to visualize
- 2-3 seems like sweet spot

---

## Technical Considerations

### Comparison Data Structure

```typescript
interface BranchComparison {
  // Branches being compared
  branches: Branch[];
  originalTimeline?: Timeline;  // Optional original
  
  // Comparison results
  comparison: {
    divergencePoint: Event;
    similarityMatrix: SimilarityScore[][];
    differences: Difference[];
    similarities: Similarity[];
  };
  
  // Character impact
  characterImpact: {
    characterId: string;
    outcomes: Record<string, CharacterOutcome>;  // branchId -> outcome
  }[];
  
  // Event comparison
  eventComparison: {
    eventId: string;
    presentIn: string[];  // branchIds
    modifiedIn: string[];
    absentIn: string[];
  }[];
}

interface SimilarityScore {
  branchA: string;
  branchB: string;
  score: number;  // 0-1
  dimensions: {
    plot: number;
    characters: number;
    tone: number;
    themes: number;
  };
}
```

---

## Decisions Recorded

| Question | Decision | Rationale |
|----------|----------|-----------|
| 1. Comparison Dimensions | **All 8 in given order** | Character → Plot → Tone → Theme → Relationship → World → Pacing → Length |
| 2. Visualization Style | **D. Tree diagram** | Branching tree from anchor point shows relationships clearly |
| 3. Similarity Quantification | **B. Character fate** | Who lives/dies/succeeds is most important comparison |
| 4. What Stays Same | **C + D. Detailed with toggle** | Show explicitly, user can hide if cluttered |
| 5. Comparison Scope | **C. Full arc** | Complete story divergence shown |
| 6. Multi-Branch Comparison | **D. Unlimited** | All selected branches can be compared at once |

### 8-Dimension Comparison Priority

```typescript
interface ComparisonDimensions {
  // 1. Character Outcomes (Highest Priority)
  characterOutcomes: {
    priority: 1,
    display: 'prominent',
    data: {
      survival: 'Who lives or dies';
      success: 'Who achieves goals';
      relationships: 'Who ends up with whom';
      power: 'Power level changes';
    }
  };
  
  // 2. Plot Divergence
  plotDivergence: {
    priority: 2,
    display: 'timeline-highlighted',
    data: {
      changedEvents: 'Which events differ';
      newEvents: 'Events unique to branch';
      removedEvents: 'Events that dont happen';
    }
  };
  
  // 3. Emotional Tone
  emotionalTone: {
    priority: 3,
    display: 'badge-style',
    data: {
      overallTone: 'Optimistic/Tragic/Bittersweet';
      characterMoods: 'Key emotional states';
      endingFeel: 'How story concludes emotionally';
    }
  };
  
  // 4. Theme Emphasis
  themeEmphasis: {
    priority: 4,
    display: 'tag-cloud',
    data: {
      primaryThemes: 'Main themes explored';
      themeStrength: 'How prominently each theme appears';
    }
  };
  
  // 5. Relationship Changes
  relationshipChanges: {
    priority: 5,
    display: 'network-graph',
    data: {
      formed: 'New relationships';
      broken: 'Relationships that end';
      evolved: 'Relationships that change';
    }
  };
  
  // 6. World State Differences
  worldState: {
    priority: 6,
    display: 'summary-list',
    data: {
      political: 'Power structure changes';
      social: 'Society/culture shifts';
      physical: 'Setting changes';
    }
  };
  
  // 7. Pacing Differences
  pacing: {
    priority: 7,
    display: 'meter-bar',
    data: {
      speed: 'Faster/slower than original';
      tension: 'Higher/lower tension';
    }
  };
  
  // 8. Story Length
  storyLength: {
    priority: 8,
    display: 'chapter-count',
    data: {
      estimatedChapters: 'Branch length';
      comparison: 'Shorter/longer than original';
    }
  };
}
```

### Tree Diagram Visualization

```typescript
interface TreeDiagramVisualization {
  type: 'branching-tree';
  
  structure: {
    root: {
      label: 'Anchor Event';
      position: { x: 0; y: 0 };
    };
    
    branches: {
      id: string;
      label: string;  // Branch name
      angle: number;  // Spread from root
      length: number; // Visual length based on arc length
      color: string;  // Unique color per branch
      
      // Nodes along branch
      nodes: {
        type: 'divergence' | 'convergence' | 'milestone';
        label: string;
        position: { x: number; y: number };
      }[];
    }[];
  };
  
  interactivity: {
    zoom: 'zoom in/out';
    pan: 'move view';
    select: 'click branch to focus';
    compare: 'multi-select to highlight differences';
  };
}

// Visual representation:
//              [Anchor: Kira's Choice]
//                     |
//        _____________|_____________
//       /              |             \
//  [Save Village]  [Pursue Spy]  [Call Help]
//       |              |             |
//    [Village      [Spy        [Reinforcements
//     Saved]        Caught]      Arrive]
//       |              |             |
//    [etc...]       [etc...]      [etc...]
```

### Character Fate Similarity

```typescript
interface CharacterFateSimilarity {
  // Primary comparison metric
  metric: 'character-fate';
  
  calculation: {
    // For each character, compare outcomes
    characterOutcomes: {
      characterId: string;
      characterName: string;
      
      // Outcome per branch
      outcomes: Record<string, CharacterOutcome>; // branchId -> outcome
      
      // Similarity score
      outcomeSimilarity: number;  // 0-1
    }[];
    
    // Aggregate similarity
    overallSimilarity: number;  // Average of character similarities
  };
  
  outcomeCategories: {
    survival: 'alive' | 'dead' | 'unknown';
    success: 'succeeded' | 'failed' | 'partial' | 'ongoing';
    happiness: 'happy' | 'content' | 'struggling' | 'tragic';
    power: 'increased' | 'decreased' | 'unchanged';
    relationships: 'improved' | 'worsened' | 'changed' | 'stable';
  };
}
```

### Detailed + Toggle Similarities

```typescript
interface SimilarityDisplay {
  // Default: Show detailed similarities
  defaultMode: 'detailed';
  
  sections: {
    whatStaysSame: {
      visible: true;
      content: string[];  // List of unchanged elements
      collapsible: true;
    };
    
    whatChanges: {
      visible: true;
      content: Change[];
      collapsible: false;  // Always visible
    };
  };
  
  // User toggle
  userToggle: {
    label: 'Show similarities';
    state: 'expanded' | 'collapsed';
    action: () => void;
  };
}

// Example display:
// ┌─ WHAT STAYS THE SAME [−]
// │ • Magic system unchanged
// │ • Empire remains antagonist
// │ • Prophecy still valid
// └─
// ┌─ WHAT CHANGES [always visible]
// │ • Kira's relationship with Rook
// │ • Village survival
// └─
```

### Full Arc Comparison Scope

```typescript
interface FullArcComparison {
  scope: 'full-arc';
  
  coverage: {
    beginning: 'From anchor point';
    middle: 'All major plot points';
    end: 'Complete story conclusion';
  };
  
  // Progressive loading
  progressiveLoad: {
    initial: 'Show major milestones only';
    onDemand: 'Expand to show detailed events';
  };
}
```

### Unlimited Multi-Branch Comparison

```typescript
interface UnlimitedBranchComparison {
  // No artificial limit
  maxBranches: 'unlimited';
  
  // Practical considerations
  practicalLimits: {
    warningAt: 10;  // "Comparing 10+ branches may be cluttered"
    suggestBreakAt: 15;  // Suggest splitting into groups
  };
  
  // Visualization adapts
  adaptiveVisualization: {
    '2-3': 'Detailed tree, full details';
    '4-6': 'Compact tree, summary nodes';
    '7-10': 'Overview mode, click to expand';
    '10+': 'Comparison matrix, tree on select';
  };
}
```

---

## Status: ✅ ALL SUB-COMPONENTS COMPLETE

**Component 5: Branch Generator fully interrogated and specified.**
