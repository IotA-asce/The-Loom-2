# Sub-Component 5.1: Context Assembler

## Purpose
Gather and organize all necessary context for branch generation from the storyline analysis and anchor event.

---

## Requirements Gathering

### Question 1: Essential vs. Nice-to-Have Context

**What context is essential vs. nice-to-have for branch generation?**

Rank these by importance (must-have, important, nice-to-have, optional):

| Context Element | Your Priority |
|-----------------|---------------|
| Character personality traits | |
| Character current emotional state | |
| Character current motivations | |
| Character relationships at branch point | |
| Character past history/backstory | |
| World setting description | |
| Active conflicts at branch point | |
| Unresolved plot threads | |
| Power dynamics/factions | |
| Recent events leading to anchor | |
| Events after anchor (for contrast) | |
| Original author's writing style | |
| Genre conventions | |
| Themes of the story | |

### Question 2: Character History Scope

**How much character history should be included?**

Options:
- **A. Minimal:** Only traits and current state
- **B. Relevant:** Key backstory that informs current decisions
- **C. Full arc:** Character development up to branch point
- **D. Selective:** AI chooses what's relevant

Considerations:
- More history = better consistency but longer prompts
- Some history may be irrelevant to the branch
- Key backstory moments may be crucial

### Question 3: Post-Anchor Event Handling

**Should we include events after the anchor (for contrast) or only events before?**

Options:
- **A. Before only:** Don't bias toward original outcome
- **B. Brief summary:** Mention what originally happened for contrast
- **C. Full original timeline:** Show what we're diverging from
- **D. Optional:** User decides whether to include

Considerations:
- Knowing original outcome may help define "different"
- Too much info may constrain creativity
- Contrast helps understand divergence

### Question 4: Spoiler Handling

**How do we handle spoilers the characters shouldn't know yet?**

Options:
- **A. Include all:** LLM uses full knowledge for better branches
- **B. Character perspective:** Only what each character knows
- **C. Omniscient narrator:** Include but mark as narrator knowledge
- **D. Reader knowledge:** Include dramatic irony reader would have

Considerations:
- Characters making decisions shouldn't know future
- But branch quality may benefit from knowing full story
- Some genres use dramatic irony

### Question 5: Context Packaging Strategy

**How should context be packaged for the LLM?**

Options:
- **A. Flat document:** All context in one text block
- **B. Structured sections:** Organized by category
- **C. Character packets:** Per-character dossiers
- **D. Timeline narrative:** Context woven into story summary

Considerations:
- Structure affects how LLM uses information
- Too structured may feel artificial
- Narrative form may be more natural

### Question 6: Dynamic Context Selection

**Should context selection be dynamic based on anchor type?**

Options:
- **A. Universal:** Same context package for all anchors
- **B. Type-adaptive:** Different context for decision vs. accident vs. revelation
- **C. Character-focused:** More detail on involved characters
- **D. Full adaptive:** AI selects relevant context per anchor

Considerations:
- Decision anchors need motivation context
- Revelation anchors need knowledge context
- Adaptive = more complex but potentially better

---

## Technical Considerations

### Context Package Size Limits

| Provider | Context Window | Practical Limit |
|----------|----------------|-----------------|
| Gemini 1.5 Pro | 1M tokens | ~300K characters |
| GPT-4o | 128K tokens | ~40K characters |

### Context Structure Template

```typescript
interface BranchContext {
  // Source
  anchorEvent: AnchorEvent;
  selectedAlternative: AlternativeOutcome;
  
  // Characters
  characters: {
    id: string;
    name: string;
    traits: string[];
    currentState: {
      emotional: string;
      motivations: string[];
      knowledge: string[];
      location: string;
      status: string;
    };
    relationships: Record<string, string>;
    keyBackstory: string[];
  }[];
  
  // World
  world: {
    setting: string;
    time: string;
    activeConflicts: Conflict[];
    factions: Faction[];
    rules: string[];  // Hard world rules
  };
  
  // Narrative
  narrative: {
    style: string;
    tone: string;
    themes: string[];
    genre: string;
    pacing: string;
  };
  
  // History
  recentEvents: string[];  // Leading to anchor
  originalOutcome?: string;  // What originally happened
}
```

---

## Decisions Recorded

| Question | Decision | Rationale |
|----------|----------|-----------|
| 1. Context Priority | **All elements are MUST-HAVE** | Comprehensive context for best branch quality |
| 2. Character History | **C. Full arc** | Complete development up to branch point |
| 3. Post-Anchor Events | **D. Optional** | User decides whether to include original outcome |
| 4. Spoiler Handling | **A. Include all** | LLM uses full knowledge for best branch generation |
| 5. Context Packaging | **D. Timeline narrative** | Woven into story summary for natural flow |
| 6. Dynamic Selection | **D. Full adaptive** | AI selects most relevant context per anchor type |

### Comprehensive Context Package

All context elements are essential:
- ✅ Character personality traits
- ✅ Character current emotional state
- ✅ Character current motivations
- ✅ Character relationships at branch point
- ✅ Character past history/backstory (full arc)
- ✅ World setting description
- ✅ Active conflicts at branch point
- ✅ Unresolved plot threads
- ✅ Power dynamics/factions
- ✅ Recent events leading to anchor
- ✅ Events after anchor (optional per user)
- ✅ Original author's writing style
- ✅ Genre conventions
- ✅ Themes of the story

### Timeline Narrative Packaging

```typescript
interface NarrativeContext {
  // Story woven into narrative flow
  storyContext: string;  // 2000-4000 words
  // Includes:
  // - Setting description woven into opening
  // - Character introductions as they appear in story
  // - Recent events as flowing narrative
  // - Character states shown through their current situation
  // - Relationships revealed through interactions
  // - World rules demonstrated through events
  // - Themes emerging from story beats
}

// Example structure:
// "In the kingdom of Aethoria, where magic flows through ancient...
//  Kira, a young blacksmith with copper hair and fierce determination,
//  stood at a crossroads. Three days ago, she had discovered the ancient
//  forge beneath her family's workshop... [character arc woven in]
//  Her relationship with Rook, strained since the revelation of his...
//  [relationships woven in]
//  The Empire's grip tightens across the land, their ironclad soldiers...
//  [conflicts and world state woven in]"
```

### Adaptive Context Selection

```typescript
interface AdaptiveContextSelector {
  // AI analyzes anchor and selects relevant emphasis
  selectContextEmphasis(anchor: AnchorEvent): ContextEmphasis;
}

interface ContextEmphasis {
  // For decision anchors - focus on motivations
  characterDepth: 'minimal' | 'standard' | 'deep';
  
  // For accident anchors - focus on circumstances
  worldDetail: 'minimal' | 'standard' | 'deep';
  
  // For revelation anchors - focus on knowledge gaps
  knowledgeStates: 'minimal' | 'standard' | 'deep';
  
  // For conflict anchors - focus on power dynamics
  conflictDetail: 'minimal' | 'standard' | 'deep';
  
  // Dynamic word count based on complexity
  targetWordCount: number;  // 2000-6000 words
}

// Decision anchor → Deep character focus
// Accident anchor → Deep world/circumstance focus
// Revelation anchor → Deep knowledge state focus
// Conflict anchor → Deep power dynamic focus
```

### User Toggle for Post-Anchor Events

```typescript
interface ContextConfiguration {
  includeOriginalOutcome: boolean;  // User toggle
  originalOutcomeDetail: 'summary' | 'full' | 'none';
  
  // When enabled:
  // "In the original timeline, Kira chose to save the village.
  //  This led to the Empire's spy escaping with crucial intelligence,
  //  setting up the betrayal in Chapter 7..."
}
```

### Full Character Arc Inclusion

```typescript
interface CharacterContext {
  id: string;
  name: string;
  
  // Full arc up to branch point
  arc: {
    introduction: string;      // How introduced
    keyDevelopment: string[];  // Major growth moments
    relationshipsEvolved: RelationshipChange[];
    currentState: CharacterState;
  };
  
  // Woven into narrative, not bullet points
  narrativeSummary: string;  // 200-500 words per character
}
```

---

## Status: ✅ Interrogation Complete

**Next: Sub-Component 5.2 — Premise Generator**
