# Sub-Component 3.2: Prompt Engine

## Purpose
Generate and manage multi-stage analysis prompts dynamically based on context, genre, and stage requirements.

---

## Requirements Gathering

### Question 1: Prompt Dynamism

**Should prompts be static or dynamically generated based on genre detection?**

Options:
- **A. Fully Static:** One prompt set for all manga
- **B. Genre-Adaptive:** Prompts adjust based on detected genre
- **C. Stage-Adaptive:** Each stage adapts to previous stage output
- **D. Fully Dynamic:** Context-aware, genre-aware, user-preference-aware

Considerations:
- Static = simpler, consistent
- Dynamic = better results but more complex
- Genre-specific prompts may improve accuracy

### Question 2: Context Window Management

**How much previous context should each stage receive?**

Options:
- **A. Minimal:** Only essential context (character names, key events)
- **B. Summarized:** AI-generated summary of previous stages
- **C. Full Context:** Complete previous stage outputs
- **D. Selective:** Choose context based on relevance algorithm

Considerations:
- More context = better continuity
- Less context = lower token usage, faster
- Context limits vary by provider

### Question 3: Genre-Specific Prompts

**Should we maintain different prompt sets for different genres?**

Options:
- **A. Universal:** Single prompt works for all genres
- **B. Major Genres:** Separate prompts for Action, Romance, Mystery, Slice of Life
- **C. Extensive:** Prompts for 10+ genre categories
- **D. Hybrid:** Base prompt + genre-specific additions

Considerations:
- Action manga needs focus on fights/powers
- Mystery needs focus on clues/revelations
- Romance needs focus on relationships/emotions

### Question 4: Prompt Versioning

**How do we handle prompt updates and A/B testing?**

Options:
- **A. Simple:** Global prompt, update for all
- **B. Versioned:** Prompts versioned, can rollback
- **C. A/B Test:** Percentage rollout of new prompts
- **D. Per-Manga:** Pin prompt version per manga

Considerations:
- Need ability to improve prompts over time
- Should be able to compare prompt performance
- Breaking changes could affect ongoing analyses

### Question 5: Few-Shot Examples

**Should prompts include example outputs (few-shot learning)?**

Options:
- **A. No examples:** Zero-shot only
- **B. Generic examples:** Same examples for all
- **C. Genre-specific examples:** Different examples per genre
- **D. Manga-specific examples:** Examples from similar manga

Considerations:
- Examples improve output consistency
- Too many examples = token bloat
- Wrong examples may bias results

### Question 6: Prompt Customization

**Should users be able to customize prompts for their analyses?**

Options:
- **A. No:** Internal prompts only
- **B. Advanced Mode:** Toggle to edit system prompt
- **C. Focus Areas:** User selects "focus on romance", "focus on action"
- **D. Full Custom:** User can write custom instructions

Considerations:
- User customization = better results for their needs
- Risk of breaking output format
- May require technical knowledge

---

## Technical Considerations

### Prompt Structure Template

```typescript
interface AnalysisPrompt {
  // Version control
  version: string;
  stage: 'visual_overview' | 'character_discovery' | 'timeline_extraction' | 'relationship_mapping' | 'theme_synthesis';
  genre?: string;
  
  // Prompt components
  systemPrompt: string;
  userPromptTemplate: string;
  fewShotExamples?: FewShotExample[];
  
  // Configuration
  temperature: number;
  maxTokens: number;
  outputSchema: z.ZodSchema;
}
```

### Prompt Assembly Flow

```
Base Prompt
    +
Genre Additions (if applicable)
    +
Context from Previous Stages
    +
Few-Shot Examples (if enabled)
    +
User Customizations (if any)
    ↓
Final Prompt → LLM
```

---

## Decisions Recorded

| Question | Decision | Rationale |
|----------|----------|-----------|
| 1. Prompt Dynamism | **B. Genre-adaptive** | Better accuracy through genre-specific guidance |
| 2. Context Management | **C. Full context** | Maximum continuity between stages |
| 3. Genre-Specific Prompts | **C. Extensive (10+)** | Comprehensive coverage for diverse manga |
| 4. Prompt Versioning | **C. A/B testing** | Data-driven prompt improvements |
| 5. Few-Shot Examples | **D. Manga-specific** | Most relevant examples for best results |
| 6. User Customization | **D. Full custom** | Power user flexibility |

### Prompt Engine Architecture

```typescript
interface PromptEngine {
  // Genre detection for prompt selection
  detectGenre(overview: VisualOverview): GenreCategory;
  
  // Load appropriate prompt set
  loadPromptSet(genre: GenreCategory, stage: AnalysisStage): PromptTemplate;
  
  // Assemble final prompt with context
  assemblePrompt(
    template: PromptTemplate,
    context: AnalysisContext,
    examples: FewShotExample[],
    userCustomizations?: string
  ): string;
  
  // A/B testing support
  getPromptVariant(experimentId: string, variant: 'A' | 'B'): PromptTemplate;
}

// Supported genres (10+)
type GenreCategory = 
  | 'shonen_action'
  | 'shonen_adventure' 
  | 'seinen_action'
  | 'seinen_psychological'
  | 'shojo_romance'
  | 'shojo_drama'
  | 'josei_romance'
  | 'josei_slice_of_life'
  | 'mystery_detective'
  | 'horror_thriller'
  | 'fantasy_isekai'
  | 'sci_fi'
  | 'sports'
  | 'comedy'
  | 'slice_of_life'
  | 'mecha'
  | 'supernatural'
  | 'historical'
  | 'unknown';
```

### Prompt Library Structure

```
prompts/
├── shared/
│   ├── system-base.md
│   ├── json-schema.md
│   └── error-recovery.md
├── genres/
│   ├── shonen-action/
│   │   ├── stage-1-overview.md
│   │   ├── stage-2-characters.md
│   │   ├── stage-3-timeline.md
│   │   ├── stage-4-relationships.md
│   │   ├── stage-5-themes.md
│   │   └── examples/
│   │       ├── character-example-1.md
│   │       └── timeline-example-1.md
│   ├── shojo-romance/
│   │   └── ...
│   ├── mystery-detective/
│   │   └── ...
│   └── ... (16 genres total)
└── experiments/
    ├── v2-shonen-action/
    └── v3-character-prompts/
```

### User Customization Interface

```typescript
interface UserPromptCustomizations {
  // Focus areas
  focusAreas: Array<'romance' | 'action' | 'mystery' | 'worldbuilding' | 'character_development'>;
  
  // Custom instructions appended to system prompt
  customInstructions?: string;
  
  // Example: "Focus on political intrigue and power dynamics"
  // Example: "Pay special attention to emotional beats and character growth"
}
```

---

## Status: ✅ Interrogation Complete

**Next: Sub-Component 3.3 — LLM Orchestrator**
