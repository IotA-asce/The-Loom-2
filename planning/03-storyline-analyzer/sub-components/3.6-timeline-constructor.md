# Sub-Component 3.6: Timeline Constructor

## Purpose
Extract events from analysis, build chronological narrative, handle non-linear storytelling, and identify significance.

---

## Requirements Gathering

### Question 1: Timeline Order Tracking

**Should we track both reading order AND chronological order?**

Options:
- **A. Reading order only:** As presented in manga
- **B. Chronological only:** True story timeline
- **C. Both:** Separate tracking for each
- **D. Primary + secondary:** One primary, other as metadata

Considerations:
- Flashbacks common in manga
- Some stories are intentionally non-linear
- Both views useful for different purposes

### Question 2: Flashback Detection

**How should flashbacks and time jumps be handled?**

Options:
- **A. Visual cues:** Detect black borders, rounded panels
- **B. Text indicators:** "Three years ago", "Flashback"
- **C. Narrative inconsistency:** Detect when story jumps
- **D. LLM flagged:** Ask LLM to mark time jumps

Considerations:
- Visual cues vary by manga style
- Text may be untranslated
- LLM most reliable but may miss subtle jumps

### Question 3: Event Granularity

**How granular should events be?**

Options:
- **A. Per panel:** Every panel is an event
- **B. Per scene:** Group related panels
- **C. Per page:** One event per page
- **D. Significance-based:** Only significant moments

Considerations:
- Too granular = overwhelming
- Too coarse = miss important beats
- Scene-level often most natural

### Question 4: Event Significance

**What constitutes a "significant" event?**

Options:
- **A. LLM judgment:** LLM scores significance
- **B. Character involvement:** Events with major characters
- **C. Plot advancement:** Moves story forward
- **D. Emotional impact:** Changes character state

Considerations:
- Significance needed for anchor event detection
- Subjective judgment varies
- May need multi-factor scoring

### Question 5: Cause and Effect

**How should cause-and-effect relationships be tracked?**

Options:
- **A. None:** Events are independent
- **B. Simple links:** Event A causes Event B
- **C. Multi-cause:** Multiple causes, multiple effects
- **D. Full dependency graph:** Complex causal chains

Considerations:
- Critical for branch generation (what if X didn't happen)
- Complex chains harder to extract accurately
- Full graph most useful but most complex

### Question 6: Timeline Gaps

**How should gaps in the timeline be handled?**

Options:
- **A. Ignore:** Assume continuous
- **B. Flag:** Note that time passed
- **C. Estimate:** Try to estimate duration
- **D. Explicit:** Note "X days later" if mentioned

Considerations:
- Time skips common (training arcs, travel)
- Duration may be unknown
- Gaps may be important for pacing

### Question 7: Parallel Events

**How should simultaneous/parallel events be handled?**

Options:
- **A. Sequentialize:** Order arbitrarily
- **B. Group:** Mark as happening together
- **C. Branch:** Separate timeline branches
- **D. Cross-reference:** Link related events

Considerations:
- Multiple POV stories have parallel threads
- Important for complete story understanding
- Complexity vs. accuracy tradeoff

---

## Technical Considerations

### Timeline Data Structure

```typescript
interface Timeline {
  // Multiple ordering perspectives
  readingOrder: Event[];
  chronologicalOrder: Event[];
  
  // Events with full metadata
  events: Event[];
  
  // Non-linear elements
  timeJumps: TimeJump[];
  flashbacks: Flashback[];
  parallelThreads: ParallelThread[];
}

interface Event {
  id: string;
  title: string;
  description: string;
  
  // Positioning
  readingPosition: number;  // Order in manga
  chronologicalPosition: number;  // Order in story time
  
  // Location in source
  pageRange: { start: number; end: number };
  
  // Significance
  significance: 'minor' | 'moderate' | 'major' | 'climax';
  significanceScore: number;  // 0-1
  
  // Causality
  causedBy: string[];  // Event IDs
  leadsTo: string[];  // Event IDs
  
  // Participation
  characters: string[];  // Character IDs
  location?: string;  // Setting ID
  
  // Timing
  timing: {
    type: 'present' | 'flashback' | 'flashforward';
    storyTime?: string;  // "Day 3", "3 years ago"
    duration?: string;  // "brief", "extended"
  };
}
```

### Non-Linear Story Detection

```typescript
function detectNonLinearElements(events: Event[]): NonLinearElements {
  const flashbacks = events.filter(e => 
    e.timing.type === 'flashback' ||
    e.description.includes('flashback') ||
    e.description.includes('remember') ||
    e.description.includes('years ago')
  );
  
  const timeJumps = detectTimeJumps(events);
  const parallelThreads = detectParallelThreads(events);
  
  return { flashbacks, timeJumps, parallelThreads };
}
```

---

## Decisions Recorded

| Question | Decision | Rationale |
|----------|----------|-----------|
| 1. Timeline Order | **C. Both reading + chronological** | Flashbacks and non-linear storytelling common |
| 2. Flashback Detection | **D. LLM flagged during extraction** | Scene/panel flagged as flashback at extraction time |
| 3. Event Granularity | **D. Significance-based** | Focus on important moments only |
| 4. Event Significance | **A+B+C+D. Multi-factor** | LLM judgment + character involvement + plot advancement + emotional impact |
| 5. Cause and Effect | **C + D. Multi-cause + Full dependency graph** | Complex causal chains for sophisticated branching |
| 6. Timeline Gaps | **C. Estimate duration** | Provide temporal context even when not explicit |
| 7. Parallel Events | **D. Cross-reference** | Link related events across parallel threads |

### Multi-Factor Significance Scoring

```typescript
interface SignificanceScore {
  // Composite score (0-1)
  overall: number;
  
  // Component scores
  components: {
    llmJudgment: number;      // LLM's direct significance rating
    characterInvolvement: number;  // Based on character importance
    plotAdvancement: number;  // How much story progresses
    emotionalImpact: number;  // Character state changes
  };
  
  // Weights (can be adjusted)
  weights: {
    llmJudgment: 0.35;
    characterInvolvement: 0.25;
    plotAdvancement: 0.25;
    emotionalImpact: 0.15;
  };
}

function calculateSignificance(event: Event, analysis: StorylineAnalysis): SignificanceScore {
  const components = {
    llmJudgment: event.llmSignificanceScore || 0.5,
    
    characterInvolvement: calculateCharacterInvolvement(
      event, 
      analysis.characters
    ),
    
    plotAdvancement: calculatePlotAdvancement(
      event,
      analysis.timeline
    ),
    
    emotionalImpact: calculateEmotionalImpact(
      event,
      analysis.characters
    )
  };
  
  const overall = 
    components.llmJudgment * 0.35 +
    components.characterInvolvement * 0.25 +
    components.plotAdvancement * 0.25 +
    components.emotionalImpact * 0.15;
  
  return { overall, components, weights };
}
```

### Full Causal Dependency Graph

```typescript
interface CausalGraph {
  nodes: Event[];
  edges: CausalEdge[];
}

interface CausalEdge {
  from: string;  // Event ID
  to: string;    // Event ID
  
  // Relationship type
  type: 'direct_cause' | 'enabling' | 'trigger' | 'contributing';
  
  // Strength of causation
  strength: number;  // 0-1
  
  // Description
  explanation: string;  // "X caused Y because..."
  
  // For "what if" analysis
  isNecessary: boolean;  // Would Y still happen without X?
  alternatives: string[];  // Other events that could cause Y
}

// Example: Multi-cause event
{
  event: "evt_020_empire_attacks",
  causedBy: [
    { from: "evt_015_kira_discovers_power", type: "trigger", strength: 0.9 },
    { from: "evt_018_spy_reports_location", type: "enabling", strength: 0.8 },
    { from: "evt_005_empire_declares_hunt", type: "contributing", strength: 0.6 }
  ]
}
```

### Flashback Detection During Extraction

```typescript
interface TimelineExtractionPrompt {
  // Each extracted event includes timing metadata
  outputFormat: {
    events: [{
      // ... other fields
      timing: {
        storyOrder: number;     // Position in reading
        chronologicalOrder: number;  // Position in actual timeline
        isFlashback: boolean;
        isFlashforward: boolean;
        storyTimeDescription: string;  // "3 years ago", "Next day"
        estimatedTimeOffset: string;   // "-3 years", "+1 day"
      }
    }]
  }
}

// LLM instructed to flag during extraction:
// "If this scene is a flashback, set isFlashback: true
//  and describe when it takes place in storyTimeDescription"
```

### Parallel Event Cross-Referencing

```typescript
interface ParallelEventReference {
  eventA: string;
  eventB: string;
  relationship: 'simultaneous' | 'overlapping' | 'alternating';
  
  // Narrative connection
  connectionType: 'same_time_different_place' | 
                  'cause_effect_across_threads' | 
                  'contrasting_perspectives';
  
  // For visualization
  threadA: string;  // Timeline thread ID
  threadB: string;
}

// Example: Two characters' perspectives of same battle
{
  eventA: "evt_025_kira_fights",
  eventB: "evt_026_rook_watches",
  relationship: 'simultaneous',
  connectionType: 'contrasting_perspectives',
  threadA: 'protagonist_thread',
  threadB: 'ally_thread'
}
```

### Timeline Gap Estimation

```typescript
interface TimelineGap {
  fromEvent: string;
  toEvent: string;
  
  // Estimation
  estimatedDuration: {
    min: string;  // "1 day"
    max: string;  // "1 week"
    bestGuess: string;  // "3 days"
    confidence: number;
  };
  
  // Evidence
  clues: string[];  // "Characters mention training", "Season change visible"
  
  // Narrative impact
  importance: 'minor_skip' | 'significant_time_passed' | 'timeskip_arc';
}

// Gap estimation based on:
// - Explicit mentions ("Two days later")
// - Visual cues (season, clothing, character growth)
// - Narrative context (training arc, journey)
// - Character dialogue references
```

---

## Status: ✅ Interrogation Complete

**Next: Sub-Component 3.7 — Quality Assessor**
