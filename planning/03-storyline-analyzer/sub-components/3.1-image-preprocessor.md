# Sub-Component 3.1: Image Preprocessor

## Purpose
Prepare manga page images for LLM analysis through quality assessment, optimization, and batching.

---

## Requirements Gathering

### Question 1: Image Quality Thresholds

**What is the minimum acceptable image quality for analysis?**

Options:
- **A. Strict:** Minimum 1200x1600px (high quality only)
- **B. Balanced:** Minimum 800x1200px with upscaling option
- **C. Permissive:** Any resolution, confidence adjusts to quality
- **D. User-configurable:** Default + advanced settings

Considerations:
- Too strict = rejects many user uploads
- Too permissive = poor analysis quality
- Upscaled low-res may hallucinate details

### Question 2: AI Upscaling

**Should we offer AI upscaling for low-quality scans?**

Options:
- **A. Yes, automatic:** Always upscale if below threshold
- **B. Yes, optional:** User toggle, default off
- **C. No:** Reject low quality, request better scans
- **D. Hybrid:** Upscale for preview, warn for analysis

Considerations:
- Adds processing time
- May introduce artifacts
- Better than rejecting user content
- Real-ESRGAN WASM exists but large

### Question 3: Double-Page Spreads

**How should double-page spreads be handled?**

Options:
- **A. Analyze as single unit:** Send combined image to LLM
- **B. Split for analysis:** Analyze left and right separately
- **C. Both:** Analyze combined + individual for context
- **D. User choice:** Detect and ask user preference

Considerations:
- Spreads often have important visual flow
- Gemini can handle wide images
- Splitting may lose narrative continuity

### Question 4: Image Format Strategy

**What image format should be sent to LLMs?**

Options:
- **A. Original:** No conversion, send as-is
- **B. WebP:** Modern, efficient, supported by both
- **C. JPEG:** Maximum compatibility
- **D. Adaptive:** WebP for Gemini, JPEG for OpenAI

Considerations:
- WebP ~30% smaller than JPEG
- Both Gemini and GPT-4V support WebP
- Conversion adds processing time

### Question 5: Preprocessing Pipeline

**What preprocessing steps should be configurable?**

Possible options (select priority):
- [ ] Resolution adjustment (resize up/down)
- [ ] Denoising (remove scan artifacts)
- [ ] Contrast enhancement
- [ ] Auto-rotate (fix orientation)
- [ ] Crop margins (remove scan borders)
- [ ] Grayscale conversion (for manga)

---

## Technical Constraints

### Batch Size Limits

| Provider | Max Images | Context Window | Est. Optimal Batch |
|----------|------------|----------------|-------------------|
| Gemini 1.5 Pro | 3000 | 1M tokens | 50-100 pages |
| GPT-4o | 100 | 128K tokens | 10-20 pages |

### Image Size Limits

| Provider | Max Resolution | Notes |
|----------|---------------|-------|
| Gemini | No explicit limit | Practical limit based on tokens |
| OpenAI | 20MB per image | Max 512px shortest side recommended |

---

## Decisions Recorded

| Question | Decision | Rationale |
|----------|----------|-----------|
| 1. Quality Threshold | **D. User-configurable** | Flexibility for different user needs |
| 2. AI Upscaling | **B. Optional toggle, default off** | User control, avoids surprising artifacts |
| 3. Double-page spreads | **A. Analyze as single unit** | Preserves visual flow and narrative continuity |
| 4. Image format | **B. WebP** | Efficient, both providers support it |
| 5. Preprocessing | **Crop margins, auto-rotate** | Essential for scan quality |

### Configuration Schema (User-Configurable)

```typescript
interface ImagePreprocessingConfig {
  quality: {
    mode: 'strict' | 'balanced' | 'permissive' | 'custom';
    minWidth: number;      // default: 800
    minHeight: number;     // default: 1200
    maxDimension: number;  // default: 2048
  };
  
  upscaling: {
    enabled: boolean;      // default: false
    targetScale: number;   // default: 2x
    model: 'real-esrgan' | 'lanczos';
  };
  
  spreads: {
    detect: boolean;       // default: true
    handleAs: 'single' | 'split' | 'both';
  };
  
  format: {
    output: 'webp' | 'jpeg' | 'original';
    quality: number;       // 0-100, default: 85
  };
  
  preprocessing: {
    cropMargins: boolean;  // default: true
    autoRotate: boolean;   // default: true
    denoise: boolean;      // default: false
    enhanceContrast: boolean; // default: false
  };
}
```

### Default Configuration

```typescript
const DEFAULT_PREPROCESSING_CONFIG: ImagePreprocessingConfig = {
  quality: {
    mode: 'balanced',
    minWidth: 800,
    minHeight: 1200,
    maxDimension: 2048
  },
  upscaling: {
    enabled: false,
    targetScale: 2,
    model: 'real-esrgan'
  },
  spreads: {
    detect: true,
    handleAs: 'single'
  },
  format: {
    output: 'webp',
    quality: 85
  },
  preprocessing: {
    cropMargins: true,
    autoRotate: true,
    denoise: false,
    enhanceContrast: false
  }
};
```

---

## Status: ✅ Interrogation Complete

**Next: Sub-Component 3.2 — Prompt Engine**
